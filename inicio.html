<!-- inicio.html -->
<div class="dashboard">
  <h2 class="dash-title">Welcome back, <?= usuario.nombre ?>!</h2>
  <p class="dash-sub">Here’s what’s happening today.</p>

  <!-- KPIs -->
  <section class="grid kpi-grid">
    <article class="card kpi" id="kpiSalasCard">
      <h3 class="kpi-title">Total Salas</h3>
      <div class="kpi-value" id="kpiTotalSalas"><span class="mini-spinner"></span></div>
      <small class="kpi-sub">registradas</small>
    </article>

    <article class="card kpi" id="kpiReservasCard">
      <h3 class="kpi-title">Total Reservas (30 días)</h3>
      <div class="kpi-value" id="kpiReservas30"><span class="mini-spinner"></span></div>
      <small class="kpi-sub">últimos 30 días</small>
    </article>

    <article class="card kpi" id="kpiUsuariosCard">
      <h3 class="kpi-title">Total Usuarios</h3>
      <div class="kpi-value" id="kpiTotalUsuarios"><span class="mini-spinner"></span></div>
      <small class="kpi-sub">registrados</small>
    </article>

    <article class="card kpi" id="kpiProximasCard">
      <h3 class="kpi-title">Mis próximas reservas</h3>
      <div class="kpi-value" id="kpiMisReservas"><span class="mini-spinner"></span></div>
      <small class="kpi-sub">futuras</small>
    </article>
  </section>

  <!-- Listado + Gráfico -->
  <section class="grid content-grid">
    <article class="card">
      <div class="card-head">
        <h3>My Upcoming Bookings</h3>
        <small>Las 5 próximas</small>
      </div>
      <div class="table-wrap">
        <table class="table-modern">
          <thead>
            <tr><th>Sala</th><th>Fecha</th><th>Hora</th><th>Estado</th></tr>
          </thead>
          <tbody id="upcomingTableBody">
            <tr><td colspan="4" class="td-center"><span class="mini-spinner"></span></td></tr>
          </tbody>
        </table>
      </div>
    </article>

    <article class="card">
      <div class="card-head">
        <h3>Booking Trends</h3>
        <small>Últimos 6 meses</small>
      </div>
      <div class="chart-wrapper">
        <canvas id="bookingTrendsChart" aria-label="Booking trends chart"></canvas>
        <div id="chartSpinner" class="mini-spinner abs-center"></div>
      </div>
    </article>
  </section>
</div>

<!-- Chart.js (necesario para el gráfico) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(function(){
  // Helpers
  const $ = (s, r=document) => r.querySelector(s);

  function gsRun(fn, data) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[fn](data);
    });
  }

  // '05/09/2025 13:00' -> Date
  function parseFechaDMY(str){
    if(!str) return null;
    const [fecha, hora] = String(str).split(' ');
    if(!fecha || !hora) return null;
    const [d,m,y] = fecha.split('/');
    if(!d||!m||!y) return null;
    return new Date(`${y}-${m}-${d}T${hora}`);
  }

  // KPIs
  async function loadKPIs(){
    const now = new Date();
    const promises = [
      gsRun('getAllSalas'),                     // listado de salas
      gsRun('getReservasUltimos30Dias'),        // nº reservas 30d
      ['admin','manager'].includes(window.USER_ROLE) ? gsRun('getAllUsuarios') : Promise.resolve(null),
      gsRun('getMisReservas', window.USER_EMAIL) // reservas del usuario en tabla dd/MM/yyyy HH:mm
    ];
    const [salas,total30,usuarios,mis] = await Promise.all(promises);
    const futuras = (mis||[]).filter(r => {
      const d = parseFechaDMY(r.Inicio);
      return d && d > now;
    }).length;

    $('#kpiTotalSalas').textContent    = (salas||[]).length;                     // getAllSalas() :contentReference[oaicite:2]{index=2}
    $('#kpiReservas30').textContent    = total30 || 0;                           // getReservasUltimos30Dias() :contentReference[oaicite:3]{index=3}
    if(usuarios){ $('#kpiTotalUsuarios').textContent = (usuarios||[]).length; }  // getAllUsuarios() :contentReference[oaicite:4]{index=4}
    else { $('#kpiUsuariosCard').style.display = 'none'; }
    $('#kpiMisReservas').textContent   = futuras;                                // getMisReservas() :contentReference[oaicite:5]{index=5}
  }

  // Próximas reservas (tabla)
  async function loadUpcoming(){
    const now = new Date();
    const reservas = await gsRun('getMisReservas', window.USER_EMAIL);           // dd/MM/yyyy HH:mm :contentReference[oaicite:6]{index=6}
    const futuras = (reservas||[])
      .filter(r => { const d = parseFechaDMY(r.Inicio); return d && d >= now; })
      .sort((a,b) => parseFechaDMY(a.Inicio) - parseFechaDMY(b.Inicio))
      .slice(0,5);

    const tbody = $('#upcomingTableBody');
    tbody.innerHTML = '';
    if(!futuras.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" class="td-center">You have no upcoming bookings.</td>`;
      tbody.appendChild(tr);
      return;
    }
    futuras.forEach(r => {
      const d = parseFechaDMY(r.Inicio);
      const fecha = d.toLocaleDateString();
      const hora  = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.Sala}</td><td>${fecha}</td><td>${hora}</td><td>${r.Estado||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Gráfico
  async function loadTrends(){
    const data = await gsRun('getReservasPorMes', { months: 6 });               // devuelve [{mes, total}] :contentReference[oaicite:7]{index=7}
    const labels = data.map(d => d.mes);
    const values = data.map(d => d.total);
    const ctx = $('#bookingTrendsChart').getContext('2d');
    if(window.chartTrends) window.chartTrends.destroy();
    window.chartTrends = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ data: values, backgroundColor: '#bc348b' }] },
      options: {
        responsive: true,
        plugins: { legend: { display:false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
    $('#chartSpinner').style.display = 'none';
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    loadKPIs().catch(console.error);
    loadUpcoming().catch(console.error);
    loadTrends().catch(console.error);
  });
})();
</script>
