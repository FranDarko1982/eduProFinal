<!-- reservas.html -->
<style>
  .reservas-container .salas-table-container { margin-top:0 !important; }
  /* Modal activo (por si tu CSS original lo usaba) */
  .modal-reserva-bg.activo { display:flex !important; }

  /* Indicadores y cursor para columnas ordenables */
  .table-style th[data-sort]{ cursor:pointer; user-select:none; }
</style>

<div class="reservas-container" id="reservas-admin-root">
  <div class="reservas-header"
       style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">

    <!-- Filtros en cascada -->
    <div class="filter-style">
      <div class="filter">
        <label for="filterCiudadAll">Ciudad:</label>
        <select id="filterCiudadAll">
          <option value="">‚Äî Elige Ciudad ‚Äî</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterCentroAll">Centro:</label>
        <select id="filterCentroAll" disabled>
          <option value="">‚Äî Elige Centro ‚Äî</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterSalaAll">Sala:</label>
        <select id="filterSalaAll" disabled>
          <option value="">‚Äî Elige Sala ‚Äî</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterFechaAll">Fecha:</label>
        <input id="filterFechaAll" type="text" placeholder="Selecciona fecha" />
      </div>

      <button type="button" id="clearFiltersAll" class="btn-filters-clear">Quitar filtros</button>
      <button type="button" id="reloadDataAll"  class="btn-filters-clear" style="margin-left: .5rem;">Recargar datos</button>
    </div>

    <!-- Buscador de ID Reserva -->
    <div class="filter-style" style="margin-bottom:0;">
      <div class="filter">
        <label for="searchIdAll">Buscar por ID Reserva:</label>
        <input id="searchIdAll" type="text" placeholder="Introduce ID Reserva‚Ä¶" />
      </div>
      <button type="button" id="exportAllCsv" class="btn-filters-clear">Exportar CSV</button>   
    </div>
  </div>

  <!-- Tabla -->
  <div class="salas-table-container">
    <table id="allReservasTable" class="table-style">
      <thead>
        <tr>
          <th data-sort="ID">ID Reserva</th>
          <th data-sort="Sala">Sala</th>
          <th data-sort="Capacidad">Capacidad</th>
          <th data-sort="Ciudad">Ciudad</th>
          <th data-sort="Centro">Centro</th>
          <th data-sort="Usuario">Usuario</th>
          <th data-sort="Motivo">Motivo</th>
           <th data-sort="Personas">Personas</th>
          <th data-sort="Inicio">Inicio</th>
          <th data-sort="Fin">Fin</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal editar reserva -->
  <div id="editModalAll" class="modal-reserva-bg" style="display:none;">
    <div class="modal-reserva">
      <h2 class="modal-reserva-titulo">Editar Reserva</h2>
      <form id="formEditReservaAll" autocomplete="off">
        <input id="editMotivoAll" type="text" class="modal-reserva-input" placeholder="Motivo de la reserva" required />
        <input id="editMotivoModAll" type="text" class="modal-reserva-input" placeholder="Motivo de la modificaci√≥n" required />
        <div class="modal-reserva-fechas">
          <div>
            <label for="editFechaInicioAll" class="modal-reserva-label">Fecha inicio</label><br />
            <input id="editFechaInicioAll" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
          <div>
            <label for="editFechaFinAll" class="modal-reserva-label">Fecha fin</label><br />
            <input id="editFechaFinAll" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
        </div>
        <div class="modal-reserva-fechas">
          <div>
            <label for="editHoraInicioAll" class="modal-reserva-label">Hora inicio</label><br />
            <input id="editHoraInicioAll" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
          <div>
            <label for="editHoraFinAll" class="modal-reserva-label">Hora fin</label><br />
            <input id="editHoraFinAll" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
        </div>
        <div class="modal-reserva-botones">
          <button type="button" id="btnEditCancelarAll" class="modal-reserva-btn-cancelar">Cancelar</button>
          <button type="submit" id="btnEditGuardarAll" class="modal-reserva-btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal eliminar reserva -->
  <div id="deleteOverlayAll" class="modal-overlay" style="display:none;">
    <div class="modal flex-col">
      <div class="modal-header mb-2">Eliminar Reserva</div>
      <div class="modal-body flex flex-col gap-3">
        <p id="deleteMsgAll" class="text-[#0d151b]"></p>
      </div>
      <div class="modal-footer" style="display:flex;gap:1rem;">
        <button id="btnDeleteCancelAll" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
        <button id="btnDeleteOkAll"     class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal informaci√≥n gen√©rico -->
  <div id="infoOverlayAll" class="modal-overlay" style="display:none;">
    <div class="modal flex-col">
      <div id="infoHeaderAll" class="modal-header mb-2">Informaci√≥n</div>
      <div class="modal-body flex flex-col gap-3">
        <p id="infoMsgAll" class="text-[#0d151b]"></p>
      </div>
      <div class="modal-footer">
        <button id="btnInfoOkAll" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
(function (w) {

  const AdminApp = {
    state: {
      reservas: [],
      currentEditId: null,
      deleteId: null,
      sortBy: 'Inicio',   // campo por defecto
      sortDir: 'asc'      // 'asc' | 'desc'
    },

    init() {
      // Cargar datos al entrar
      this.recargarReservas();

      // Listeners filtros/b√∫squeda
      id('filterCiudadAll').addEventListener('change', () => { this.poblarCentros(); this.poblarSalas(); this.renderTabla(); });
      id('filterCentroAll').addEventListener('change', () => { this.poblarSalas(); this.renderTabla(); });
      id('filterSalaAll').addEventListener('change', () => this.renderTabla());
      id('filterFechaAll').addEventListener('change', () => this.renderTabla());
      id('searchIdAll').addEventListener('input', () => this.renderTabla());
      id('clearFiltersAll').addEventListener('click', () => this.limpiarFiltros());
      id('reloadDataAll').addEventListener('click', () => this.recargarReservas());
      id('exportAllCsv').addEventListener('click', () => this.exportCsv());

      // Modales info
      id('btnInfoOkAll').addEventListener('click', () => this.hideInfoModal());
      id('infoOverlayAll').addEventListener('click', e => { if (e.target === e.currentTarget) this.hideInfoModal(); });

      // Modal editar
      id('btnEditCancelarAll').addEventListener('click', () => this.closeEditModal());
      id('editModalAll').addEventListener('click', e => { if (e.target === e.currentTarget) this.closeEditModal(); });
      id('formEditReservaAll').addEventListener('submit', e => this.submitEdit(e));

      // Flatpickr para filtro de fecha
      this.fp_filterFechaAll = flatpickr('#filterFechaAll', {
        enableTime: false,
        dateFormat: 'Y-m-d',
        locale: 'es',
        onChange: () => this.renderTabla()
      });

      // Flatpickr para modal editar
      this.fp_editFechaInicioAll = flatpickr('#editFechaInicioAll', {
        enableTime: false,
        dateFormat: 'Y-m-d',
        locale: 'es'
      });
      this.fp_editFechaFinAll = flatpickr('#editFechaFinAll', {
        enableTime: false,
        dateFormat: 'Y-m-d',
        locale: 'es'
      });
      this.fp_editHoraInicioAll = flatpickr('#editHoraInicioAll', {
        enableTime: true,
        noCalendar: true,
        time_24hr: true,
        dateFormat: 'H:i',
        locale: 'es',
        minuteIncrement: 5
      });
      this.fp_editHoraFinAll = flatpickr('#editHoraFinAll', {
        enableTime: true,
        noCalendar: true,
        time_24hr: true,
        dateFormat: 'H:i',
        locale: 'es',
        minuteIncrement: 5
      });

      // Modal eliminar
      id('btnDeleteCancelAll').addEventListener('click', () => this.closeDeleteModal());
      id('deleteOverlayAll').addEventListener('click', e => { if (e.target === e.currentTarget) this.closeDeleteModal(); });
      id('btnDeleteOkAll').addEventListener('click', () => this.confirmDelete());

      // Ordenaci√≥n
      this.setupSorting();
    },

    recargarReservas() {
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(d => {
          console.log('getTodasReservas -> length:', Array.isArray(d) ? d.length : 'no array', d?.slice?.(0,3));
          this.state.reservas = Array.isArray(d) ? d : [];
          w.__debugReservas = this.state.reservas; // para inspeccionar
          this.poblarCiudades();
          this.renderTabla();
          if (typeof hideSpinner === 'function') hideSpinner();
        })
        .withFailureHandler(err => {
          if (typeof hideSpinner === 'function') hideSpinner();
          console.error('Error getTodasReservas:', err);
          alert('Error al cargar las reservas.');
        })
        .getTodasReservas();
    },

    poblarCiudades() {
      const sel = id('filterCiudadAll');
      sel.innerHTML = '<option value="">‚Äî Elige Ciudad ‚Äî</option>';
      [...new Set(this.state.reservas.map(r => r.Ciudad?.trim()).filter(Boolean))].sort()
        .forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
      sel.disabled = false;
      // reset dependientes
      id('filterCentroAll').innerHTML = '<option value="">‚Äî Elige Centro ‚Äî</option>';
      id('filterSalaAll').innerHTML   = '<option value="">‚Äî Elige Sala ‚Äî</option>';
    },

    poblarCentros() {
      const ciudad = id('filterCiudadAll').value;
      const sel = id('filterCentroAll');
      sel.innerHTML = '<option value="">‚Äî Elige Centro ‚Äî</option>';
      let datos = this.state.reservas;
      if (ciudad) datos = datos.filter(r => r.Ciudad?.trim() === ciudad);
      [...new Set(datos.map(r => r.Centro?.trim()).filter(Boolean))].sort()
        .forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
      sel.disabled = false;
    },

    poblarSalas() {
      const ciudad = id('filterCiudadAll').value;
      const centro = id('filterCentroAll').value;
      const sel = id('filterSalaAll');
      sel.innerHTML = '<option value="">‚Äî Elige Sala ‚Äî</option>';
      let datos = this.state.reservas;
      if (ciudad) datos = datos.filter(r => r.Ciudad?.trim() === ciudad);
      if (centro) datos = datos.filter(r => r.Centro?.trim() === centro);
      [...new Set(datos.map(r => r.Sala?.trim()).filter(Boolean))].sort()
        .forEach(s => sel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));
      sel.disabled = false;
    },

    limpiarFiltros() {
      id('filterCiudadAll').value = '';
      this.poblarCentros();
      id('filterCentroAll').value = '';
      this.poblarSalas();
      id('filterSalaAll').value = '';
      id('filterFechaAll').value = '';
      if (this.fp_filterFechaAll) this.fp_filterFechaAll.clear();
      id('searchIdAll').value = '';
      this.renderTabla();
    },

    /* ================= ORDENACI√ìN ================= */
    setupSorting() {
      const ths = document.querySelectorAll('#allReservasTable thead th[data-sort]');
      ths.forEach(th => {
        th.dataset.label = th.textContent.trim();
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (this.state.sortBy === key) {
            this.state.sortDir = this.state.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.state.sortBy = key;
            this.state.sortDir = 'asc';
          }
          this.renderTabla();
        });
      });
      this.updateSortIndicators();
    },

    updateSortIndicators() {
      const ths = document.querySelectorAll('#allReservasTable thead th[data-sort]');
      ths.forEach(th => {
        th.classList.remove('sort-asc','sort-desc');
        if (th.dataset.sort === this.state.sortBy) {
          th.classList.add(this.state.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    },


    parseFechaDMY(str) {
      // '05/07/2025 14:00' -> Date
      if (!str) return null;
      const [fecha, hora] = String(str).split(' ');
      if (!fecha || !hora) return null;
      const [d,m,y] = fecha.split('/').map(x => x.padStart(2,'0'));
      const iso = `${y}-${m}-${d}T${hora}`;
      const dte = new Date(iso);
      return isNaN(dte) ? null : dte;
    },

    _sortValue(row, key) {
      switch (key) {
        case 'Inicio': return this.parseFechaDMY(row.Inicio);
        case 'Fin':    return this.parseFechaDMY(row.Fin);
        default:
          return (row[key] ?? '').toString().toLowerCase().trim();
      }
    },

    sortCompare(a, b) {
      const key = this.state.sortBy;
      const dir = this.state.sortDir === 'asc' ? 1 : -1;
      const av = this._sortValue(a, key);
      const bv = this._sortValue(b, key);

      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;

      if (av instanceof Date && bv instanceof Date) return (av - bv) * dir;
      if (typeof av === 'number' && typeof bv === 'number') return (av - bv) * dir;

      return av.localeCompare(bv, undefined, { numeric:true, sensitivity:'base' }) * dir;
    },
    /* =============== FIN ORDENACI√ìN =============== */

    renderTabla() {
      const ciudad = id('filterCiudadAll').value;
      const centro = id('filterCentroAll').value;
      const sala   = id('filterSalaAll').value;
      const fecha  = id('filterFechaAll').value;
      const term   = id('searchIdAll').value.toLowerCase();
      const tbody  = qs('#allReservasTable tbody');

      let datos = this.state.reservas;
      if (ciudad) datos = datos.filter(r => r.Ciudad?.trim() === ciudad);
      if (centro) datos = datos.filter(r => r.Centro?.trim() === centro);
      if (sala)   datos = datos.filter(r => r.Sala?.trim() === sala);
      if (fecha)  datos = datos.filter(r => this.splitDateTime(r.Inicio).date === fecha);
      if (term)   datos = datos.filter(r => (r.ID || '').toLowerCase().includes(term));

      // Ordenar seg√∫n estado
      datos = [...datos].sort((a,b) => this.sortCompare(a,b));
      this.updateSortIndicators();

      if (!datos.length) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#bc348b;">No hay reservas</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      datos.forEach(r => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr data-id="${r.ID}">
            <td>${r.ID}</td>
            <td>${r.Sala}</td>
            <td>${r.Capacidad ?? ''}</td>
            <td>${r.Ciudad}</td>
            <td>${r.Centro}</td>
            <td>${r.Usuario}</td>
            <td>${r.Motivo || ''}</td>
            <td>${r.Personas ?? ''}</td>
            <td>${r.Inicio}</td>
            <td>${r.Fin}</td>
            <td class="actions">
              <button onclick="AdminApp.openEditModal('${r.ID}')" title="Editar">‚úèÔ∏è</button>
              <button onclick="AdminApp.openDeleteModal('${r.ID}')" title="Eliminar">üóëÔ∏è</button>
            </td>
          </tr>`);
      });
    },

    // --------- Editar ---------
    openEditModal(idReserva) {
      const r = this.state.reservas.find(x => x.ID === idReserva);
      if (!r) return;
      this.state.currentEditId = idReserva;
      id('editMotivoAll').value = r.Motivo || '';
      id('editMotivoModAll').value = '';
      const ini = this.splitDateTime(r.Inicio);
      id('editFechaInicioAll').value = ini.date;
      id('editHoraInicioAll').value = ini.time;
      if (this.fp_editFechaInicioAll) this.fp_editFechaInicioAll.setDate(ini.date, false, 'Y-m-d');
      if (this.fp_editHoraInicioAll) this.fp_editHoraInicioAll.setDate(ini.time, false, 'H:i');
      const fin = this.splitDateTime(r.Fin);
      id('editFechaFinAll').value = fin.date;
      id('editHoraFinAll').value = fin.time;
      if (this.fp_editFechaFinAll) this.fp_editFechaFinAll.setDate(fin.date, false, 'Y-m-d');
      if (this.fp_editHoraFinAll) this.fp_editHoraFinAll.setDate(fin.time, false, 'H:i');
      id('editModalAll').style.display = 'flex';
    },
    closeEditModal() {
      id('editModalAll').style.display = 'none';
    },
    submitEdit(e) {
      e.preventDefault();
      const motivo = id('editMotivoAll').value.trim();
      const motivoCambio = id('editMotivoModAll').value.trim();
      const fechaInicio = id('editFechaInicioAll').value;
      const fechaFin    = id('editFechaFinAll').value;
      const horaInicio  = id('editHoraInicioAll').value;
      const horaFin     = id('editHoraFinAll').value;
      const inicio = `${fechaInicio}T${horaInicio}`;
      const fin    = `${fechaFin}T${horaFin}`;
      if (!motivoCambio) {
        alert('Debes indicar el motivo de la modificaci√≥n.');
        return;
      }
      if (new Date(fin) <= new Date(inicio)) {
        alert('La fecha fin no puede ser anterior a la fecha inicio.');
        return;
      }
      this.closeEditModal();
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(() => {
          this.recargarReservas();
          this.showInfoModal('Reserva actualizada correctamente.','¬°Reserva Actualizada!');
        })
        .withFailureHandler(err => {
          if(typeof hideSpinner==='function') hideSpinner();
          console.error(err);
          alert('Error actualizando la reserva');
        })
        .actualizarReserva({
          id: this.state.currentEditId,
          motivo,
          fechaInicio: inicio,
          fechaFin: fin,     // <-- coma fija el error de sintaxis
          motivoCambio
        });
    },

    // --------- Eliminar ---------
    openDeleteModal(idReserva) {
      this.state.deleteId = idReserva;
      id('deleteMsgAll').textContent = `¬øEliminar la reserva ${idReserva}?`;
      id('deleteOverlayAll').style.display = 'flex';
    },
    closeDeleteModal() {
      id('deleteOverlayAll').style.display = 'none';
    },
    confirmDelete() {
      this.closeDeleteModal();
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(() => {
          this.recargarReservas();
          this.showInfoModal('Reserva eliminada correctamente.','¬°Reserva Eliminada!');
        })
        .withFailureHandler(err => {
          if(typeof hideSpinner==='function') hideSpinner();
          console.error(err);
          alert('Error eliminando la reserva');
        })
        .eliminarReserva(this.state.deleteId);
    },

    exportCsv() {
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(csv => {
          if (typeof hideSpinner === 'function') hideSpinner();
          downloadText(csv, 'todas-reservas.csv', 'text/csv');
        })
        .withFailureHandler(err => {
          if(typeof hideSpinner==='function') hideSpinner();
          console.error(err);
          alert('Error exportando las reservas');
        })
        .exportTodasReservasCsv();
    },

    // --------- Info modal ---------
    showInfoModal(msg, header='Informaci√≥n') {
      id('infoHeaderAll').textContent = header;
      id('infoMsgAll').textContent = msg;
      id('infoOverlayAll').style.display = 'flex';
    },
    hideInfoModal() {
      id('infoOverlayAll').style.display = 'none';
    },

    // --------- Utils ---------
    splitDateTime(str) {
      // '05/07/2025 14:00' ‚Üí {date:'2025-07-05', time:'14:00'}
      const [fecha, hora] = String(str).split(' ');
      const [d, m, y] = fecha.split('/');
      return {
        date: `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`,
        time: hora
      };
    }
  };

  // Helpers cortos
  function id(sel){ return document.getElementById(sel); }
  function qs(sel){ return document.querySelector(sel); }

  // Exponer para onclicks
  w.AdminApp = AdminApp;

  document.addEventListener('DOMContentLoaded', () => {
    // solo si el enlace de men√∫ es visible (rol admin)
    const link = document.querySelector('.tab[data-id="reservas"]');
    if (link) {
      // Cargar al entrar por primera vez
      AdminApp.init();
      // Si quieres recargar cada vez que abres la pesta√±a, descomenta:
      // link.addEventListener('click', () => AdminApp.recargarReservas());
    }
  });

})(window);
</script>
