<section class="reportes-container" style="max-width:1100px;margin:1.5rem 0 1.5rem 80px;text-align:left;">
  <h1 style="margin-bottom:2rem;">Reportes</h1>

  <div class="graficos-grid">
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title azul">Por usuario</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="reservasChart" aria-label="Reservas por usuario"></canvas>
      </div>
    </article>
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title rosa">Por sala</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="salasChart" aria-label="Reservas por sala"></canvas>
      </div>
    </article>
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title rosa">Por ciudad</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="ciudadesChart" aria-label="Reservas por ciudad"></canvas>
      </div>
    </article>
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title azul">% Ocupación por centro (últimos 30 días)</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="ocupacionCentrosChart" aria-label="% Ocupación por centro (últimos 30 días)"></canvas>
      </div>
    </article>
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title azul">Evolución mensual de reservas</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="reservasMensualesChart" aria-label="Evolución mensual de reservas"></canvas>
      </div>
    </article>
    <article class="card grafico-card">
      <div class="card-head">
        <h3 class="grafico-title rosa">Distribución por horario</h3>
      </div>
      <div class="chart-wrapper">
        <canvas id="heatmapChart" aria-label="Distribución de reservas por horario"></canvas>
      </div>
    </article>
  </div>
</section>

<style>
  .graficos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2.5rem;
    margin-bottom: 2.5rem;
  }
  .grafico-card {
    width: 100%;
    max-width: 450px;
    margin: 0 auto;
  }
  .grafico-title.rosa  { color: #bc348b; margin-bottom: 0.7rem;}
  .grafico-title.azul  { color: #4c759a; margin-bottom: 0.7rem;}
  @media (max-width:1100px){
    .graficos-grid { grid-template-columns: 1fr; gap: 1.5rem; }
    .grafico-card { max-width: 100vw; }
  }
</style>

<!-- Cargar Chart.js y DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1"></script>

<script>
  // Colores corporativos
  const rosaIntelcia = 'rgba(188,52,139,0.7)';
  const azulIntelcia = 'rgba(76,117,154,0.7)';
  const naranjaSalas = 'rgba(255,159,64,0.6)';
  const azulOscuro   = 'rgba(54,162,235,0.6)';
  const gris         = 'rgba(180,180,200,0.13)';

  function renderUsersChart(data) {
    const ctx = document.getElementById('reservasChart').getContext('2d');
    const labels = data.map(d => d.email);
    const counts = data.map(d => d.count);
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Reservas por usuario',
          data: counts,
          backgroundColor: azulOscuro,
          borderColor: '#4c759a',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#444',
            font: { weight: 'bold' },
            formatter: value => value,
            clamp: true
          }
        },
        scales: {
          x: { grid: { color: gris } },
          y: { beginAtZero: true, grid: { color: gris } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderSalasChart(data) {
    const ctx = document.getElementById('salasChart').getContext('2d');
    const labels = data.map(d => d.nombre);
    const counts = data.map(d => d.count);
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Reservas por sala',
          data: counts,
          backgroundColor: naranjaSalas,
          borderColor: '#bc348b',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            color: '#444',
            font: { weight: 'bold' },
            formatter: value => value,
            clamp: true
          }
        },
        scales: {
          x: { grid: { color: gris } },
          y: { beginAtZero: true, grid: { color: gris } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderCiudadesChart(data) {
    const ctx = document.getElementById('ciudadesChart').getContext('2d');
    const labels = data.map(d => d.ciudad);
    const counts = data.map(d => d.count);
    const colores = [
      '#bc348b', '#ffb4e6', '#4c759a', '#ffc107', '#c6d4e1', '#fc97d1', '#3e4d5c'
    ];
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          label: 'Reservas por ciudad',
          data: counts,
          backgroundColor: colores,
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#bc348b', font: {weight: 'bold'} } },
          datalabels: {
            color: '#bc348b',
            font: { weight: 'bold', size: 14 },
            formatter: (value, ctx) => value > 0 ? value : '',
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed} reservas`
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderOcupacionCentrosChart(data) {
    const ctx = document.getElementById('ocupacionCentrosChart').getContext('2d');
    const labels = data.map(d => d.centro);
    const ocupacion = data.map(d => d.ocupacion);
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '% ocupación',
          data: ocupacion,
          backgroundColor: azulOscuro,
          borderColor: '#bc348b',
          borderWidth: 2
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'right',
            color: '#bc348b',
            font: { weight: 'bold' },
            formatter: value => value + ' %',
            clamp: true
          },
          tooltip: { callbacks: {
            label: ctx => `% ocupación: ${ctx.parsed.x || ctx.parsed} %`
          }}
        },
        scales: {
          x: { min: 0, max: 100, title: { display: true, text: '% ocupación' }, grid: { color: gris } },
          y: { grid: { color: gris } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  function renderReservasMensualesChart(data) {
    const ctx = document.getElementById('reservasMensualesChart').getContext('2d');
    const labels = data.map(d => d.mes);
    const counts = data.map(d => d.total);
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Reservas',
          data: counts,
          fill: false,
          borderColor: '#4c759a',
          backgroundColor: azulOscuro,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          datalabels: false
        },
        scales: {
          x: { grid: { color: gris } },
          y: { beginAtZero: true, grid: { color: gris } }
        }
      }
    });
  }

  function renderHeatmapChart(data) {
    const ctx = document.getElementById('heatmapChart').getContext('2d');
    const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    const dataset = [];
    let max = 0;
    for (let d = 0; d < 7; d++) {
      for (let h = 0; h < 24; h++) {
        const v = (data[d] && data[d][h]) || 0;
        if (v > max) max = v;
        dataset.push({ x: h, y: d, v });
      }
    }
    new Chart(ctx, {
      type: 'matrix',
      data: {
        datasets: [{
          label: 'Reservas',
          data: dataset,
          width: ({chart}) => (chart.chartArea.width / 24) - 2,
          height: ({chart}) => (chart.chartArea.height / 7) - 2,
          backgroundColor: c => {
            const value = c.dataset.data[c.dataIndex].v;
            const alpha = max ? value / max : 0;
            return `rgba(188,52,139,${alpha})`;
          },
          borderWidth: 1,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'linear', min: 0, max: 23, ticks: { stepSize: 1, callback: v => v + ':00' }, grid: { display: false } },
          y: { type: 'linear', min: 0, max: 6, ticks: { stepSize: 1, callback: v => days[v] }, grid: { display: false } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: items => `${days[items[0].raw.y]} ${items[0].raw.x}:00`,
              label: item => `${item.raw.v} reservas`
            }
          }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run.withSuccessHandler(renderUsersChart).getReservasPorUsuario();
      google.script.run.withSuccessHandler(renderSalasChart).getReservasPorSala();
      google.script.run.withSuccessHandler(renderCiudadesChart).getReservasPorCiudad();
      google.script.run.withSuccessHandler(renderOcupacionCentrosChart).getPorcentajeOcupacionPorCentro();
      google.script.run.withSuccessHandler(renderReservasMensualesChart).getReservasPorMes({ months: 12 });
      google.script.run.withSuccessHandler(renderHeatmapChart).getDistribucionReservasPorHorario();
    }
  });
</script>
