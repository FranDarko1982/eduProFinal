<!-- =========================
     PANEL DE CONTROL
     ========================= -->
<div class="panel-admin-container">
  <h1 class="panel-admin-title">Panel de control</h1>
  <p class="panel-admin-desc">
    Administra las salas y los usuarios de la aplicaci√≥n
  </p>

  <!-- Tabs -->
  <div class="panel-admin-tabs">
    <button id="tab-salas" class="panel-admin-tab active" onclick="PanelAdmin.showTab('salas')">
      Editar salas
    </button>
    <button id="tab-usuarios" class="panel-admin-tab" onclick="PanelAdmin.showTab('usuarios')">
      Editar usuarios
    </button>
  </div>

  <!-- ======= Panel Salas ======= -->
  <div id="panel-salas" class="panel-admin-panel active">
    <div id="salasEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay salas</div>
        <div class="panel-admin-desc2">A√±ade una sala para empezar a gestionar las reservas</div>
      </div>
      <button id="btnEmptyAddSala" class="panel-admin-btn">A√±adir sala</button>
    </div>

    <div id="salasTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
        <button id="btnAddSala" class="panel-admin-btn" title="A√±adir sala">+</button>
      </div>
      <table id="panelSalasTable" class="table-style">
        <thead>
          <tr>
            <th>ID Sala</th>
            <th>Centro</th>
            <th>Ciudad</th>
            <th>Nombre</th>
            <th>Capacidad</th>
            <th>Equipamiento</th>
            <th>Observaciones</th>
            <th>Horario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ======= Panel Usuarios ======= -->
  <div id="panel-usuarios" class="panel-admin-panel">
    <div id="usuariosEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay usuarios</div>
        <div class="panel-admin-desc2">A√±ade un usuario para empezar a gestionar permisos y reservas</div>
      </div>
      <button id="btnEmptyAddUser" class="panel-admin-btn">A√±adir usuario</button>
    </div>

    <div id="usuariosTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
        <button id="btnAddUser" class="panel-admin-btn" title="A√±adir usuario">+</button>
      </div>
      <table id="usuariosTable" class="table-style">
        <thead>
          <tr>
            <th>Email</th>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Campa√±a</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======= Modal editar/crear Usuario ======= -->
<div id="editUserModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Usuario</h2>
    <form id="formEditUser" autocomplete="off">
      <input id="userEmail" type="email" class="modal-reserva-input" placeholder="Email" required />
      <input id="userNombre" type="text" class="modal-reserva-input" placeholder="Nombre" />
      <select id="userRol" class="modal-reserva-input"></select>
      <input id="userCampania" type="text" class="modal-reserva-input" placeholder="Campa√±a" />
      <div class="modal-reserva-botones">
        <button type="button" id="btnUserCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnUserSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Usuario ======= -->
<div id="deleteUserOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Usuario</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteUserMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteUserCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteUserOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>

<!-- ======= Modal editar/crear Sala ======= -->
<div id="editSalaModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Sala</h2>
    <form id="formEditSala" autocomplete="off">
      <input id="salaId" type="text" class="modal-reserva-input" placeholder="ID Sala (opcional al crear)"/>
      <input id="salaCentro" type="text" class="modal-reserva-input" placeholder="Centro" required />
      <input id="salaCiudad" type="text" class="modal-reserva-input" placeholder="Ciudad" required />
      <input id="salaNombre" type="text" class="modal-reserva-input" placeholder="Nombre" required />
      <input id="salaCapacidad" type="number" class="modal-reserva-input" placeholder="Capacidad" />
      <input id="salaEquipamiento" type="text" class="modal-reserva-input" placeholder="Equipamiento" />
      <input id="salaObs" type="text" class="modal-reserva-input" placeholder="Observaciones" />
      <input id="salaHorario" type="text" class="modal-reserva-input" placeholder="Horario" />
      <div class="modal-reserva-botones">
        <button type="button" id="btnSalaCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnSalaSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Sala ======= -->
<div id="deleteSalaOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Sala</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteSalaMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteSalaCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteSalaOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>

<!-- ======= Modal informaci√≥n reutilizable ======= -->
<div id="infoOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div id="infoHeader" class="modal-header mb-2">Informaci√≥n</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="infoMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer">
      <button id="btnInfoOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Aceptar</button>
    </div>
  </div>
</div>

<script>
/* Encapsulamos todo en un namespace para evitar ‚Äúalready been declared‚Äù */
const PanelAdmin = (() => {
  // ------- Estado interno -------
  let salasOriginales = [];
  let usuariosOriginales = [];
  let roles = [];
  let currentSalaId = null;   // null => creando
  let currentEmail = null;    // null => creando
  let deleteSalaId = null;
  let deleteEmail = null;

  // ------- Helpers -------
  const show = (el) => el.style.display = 'flex';
  const hide = (el) => el.style.display = 'none';
  const qs  = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));
  const safe = (v) => (v == null ? '' : v);

  function showInfoModal(msg, header='Informaci√≥n') {
    qs('#infoHeader').textContent = header;
    qs('#infoMsg').textContent = msg;
    show(qs('#infoOverlay'));
  }
  function hideInfoModal() { hide(qs('#infoOverlay')); }

  // ------- Tabs -------
  function showTab(tab) {
    qs('#tab-salas').classList.toggle('active', tab === 'salas');
    qs('#tab-usuarios').classList.toggle('active', tab === 'usuarios');
    qs('#panel-salas').classList.toggle('active', tab === 'salas');
    qs('#panel-usuarios').classList.toggle('active', tab === 'usuarios');
  }

  // ------- Cargar Salas -------
  function cargarSalas() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        console.log('getAllSalas ->', Array.isArray(d) ? d.length : d); // debug
        salasOriginales = Array.isArray(d) ? d : [];
        renderSalas(salasOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar las salas');
      })
      .getAllSalas();
  }

  function renderSalas(salas) {
    const empty  = qs('#salasEmpty');
    const tableC = qs('#salasTableContainer');
    const tbody  = qs('#panelSalasTable tbody');

    if (!salas || !salas.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';

    const cols = ['ID Sala','Centro','Ciudad','Nombre','Capacidad','Equipamiento','Observaciones','Horario'];

    salas.forEach(r => {
      const tr = document.createElement('tr');
      cols.forEach(k => {
        const td = document.createElement('td');
        td.textContent = safe(r[k]);
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      const id = safe(r['ID Sala']).toString().replace(/"/g,'&quot;');
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openSalaEditModal('${id}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openSalaDeleteModal('${id}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  // ------- Modales Sala -------
  function openSalaAddModal() {
    currentSalaId = null;
    qs('#editSalaModal h2').textContent = 'A√±adir Sala';
    qs('#salaId').value = '';
    qs('#salaCentro').value = '';
    qs('#salaCiudad').value = '';
    qs('#salaNombre').value = '';
    qs('#salaCapacidad').value = '';
    qs('#salaEquipamiento').value = '';
    qs('#salaObs').value = '';
    qs('#salaHorario').value = '';
    qs('#editSalaModal').classList.add('activo');
  }
  function openSalaEditModal(idSala) {
    const s = salasOriginales.find(x => String(x['ID Sala']) === String(idSala));
    if (!s) return;
    currentSalaId = String(idSala);
    qs('#editSalaModal h2').textContent = 'Editar Sala';
    qs('#salaId').value = safe(s['ID Sala']);
    qs('#salaCentro').value = safe(s['Centro']);
    qs('#salaCiudad').value = safe(s['Ciudad']);
    qs('#salaNombre').value = safe(s['Nombre']);
    qs('#salaCapacidad').value = safe(s['Capacidad']);
    qs('#salaEquipamiento').value = safe(s['Equipamiento']);
    qs('#salaObs').value = safe(s['Observaciones']);
    qs('#salaHorario').value = safe(s['Horario']);
    qs('#editSalaModal').classList.add('activo');
  }
  function closeSalaEditModal() { qs('#editSalaModal').classList.remove('activo'); }

  function submitSala(e) {
    e.preventDefault();
    const payload = {
      idSala:        qs('#salaId').value.trim(),
      Centro:        qs('#salaCentro').value.trim(),
      Ciudad:        qs('#salaCiudad').value.trim(),
      Nombre:        qs('#salaNombre').value.trim(),
      Capacidad:     qs('#salaCapacidad').value.trim(),
      Equipamiento:  qs('#salaEquipamiento').value.trim(),
      Observaciones: qs('#salaObs').value.trim(),
      Horario:       qs('#salaHorario').value.trim()
    };
    closeSalaEditModal();
    if (typeof showSpinner === 'function') showSpinner();

    const fn     = currentSalaId ? 'actualizarSala' : 'crearSala';
    const okHead = currentSalaId ? '¬°Sala Actualizada!' : '¬°Sala Creada!';
    const okMsg  = currentSalaId ? 'Sala actualizada correctamente.' : 'Sala creada correctamente.';
    const errMsg = currentSalaId ? 'Error actualizando la sala' : 'Error creando la sala';

    google.script.run
      .withSuccessHandler(() => { cargarSalas(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](payload);
  }

  // Borrado Sala
  function openSalaDeleteModal(idSala) {
    deleteSalaId = idSala;
    qs('#deleteSalaMsg').textContent = '¬øEliminar la sala ' + idSala + '?';
    show(qs('#deleteSalaOverlay'));
  }
  function closeSalaDeleteModal() { hide(qs('#deleteSalaOverlay')); }
  function confirmDeleteSala() {
    closeSalaDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarSalas(); showInfoModal('Sala eliminada correctamente.','¬°Sala Eliminada!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando la sala'); })
      .eliminarSala(deleteSalaId);
  }

  // ------- Usuarios -------
  function cargarUsuarios() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        usuariosOriginales = Array.isArray(d) ? d : [];
        renderUsuarios(usuariosOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar los usuarios');
      })
      .getAllUsuarios();
  }

  function renderUsuarios(users) {
    const empty  = qs('#usuariosEmpty');
    const tableC = qs('#usuariosTableContainer');
    const tbody  = qs('#usuariosTable tbody');

    if (!users || !users.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';

    users.forEach(u => {
      const tr = document.createElement('tr');
      ['email','nombre','rol','Campa√±a'].forEach(k => {
        const td = document.createElement('td');
        td.textContent = safe(u[k]);
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openUserEditModal('${u.email}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openUserDeleteModal('${u.email}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  function cargarRoles() {
    google.script.run.withSuccessHandler(list => {
      roles = Array.isArray(list) ? list : [];
    }).getRoles();
  }

  // Modales Usuario
  function openUserAddModal() {
    currentEmail = null;
    qs('#editUserModal h2').textContent = 'A√±adir Usuario';
    qs('#userEmail').value = '';
    qs('#userNombre').value = '';
    qs('#userCampania').value = '';
    const sel = qs('#userRol');
    sel.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
    sel.value = roles[0] || '';
    qs('#editUserModal').classList.add('activo');
  }
  function openUserEditModal(email) {
    const u = usuariosOriginales.find(x => x.email === email);
    if (!u) return;
    currentEmail = email;
    qs('#editUserModal h2').textContent = 'Editar Usuario';
    qs('#userEmail').value = safe(u.email);
    qs('#userNombre').value = safe(u.nombre);
    qs('#userCampania').value = safe(u['Campa√±a']);
    const sel = qs('#userRol');
    sel.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
    sel.value = safe(u.rol);
    qs('#editUserModal').classList.add('activo');
  }
  function closeUserEditModal() { qs('#editUserModal').classList.remove('activo'); }

  function submitUser(e) {
    e.preventDefault();
    const data = {
      originalEmail: currentEmail,
      email:   qs('#userEmail').value.trim(),
      nombre:  qs('#userNombre').value.trim(),
      rol:     qs('#userRol').value,
      'Campa√±a': qs('#userCampania').value.trim()
    };
    closeUserEditModal();
    if (typeof showSpinner === 'function') showSpinner();

    const fn     = currentEmail ? 'actualizarUsuario' : 'crearUsuario';
    const okHead = currentEmail ? '¬°Usuario Actualizado!' : '¬°Usuario Creado!';
    const okMsg  = currentEmail ? 'Usuario actualizado correctamente.' : 'Usuario creado correctamente.';
    const errMsg = currentEmail ? 'Error actualizando el usuario' : 'Error creando el usuario';

    google.script.run
      .withSuccessHandler(() => { cargarUsuarios(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](data);
  }

  // Borrado Usuario
  function openUserDeleteModal(email) {
    deleteEmail = email;
    qs('#deleteUserMsg').textContent = '¬øEliminar el usuario ' + email + '?';
    show(qs('#deleteUserOverlay'));
  }
  function closeUserDeleteModal() { hide(qs('#deleteUserOverlay')); }
  function confirmDeleteUser() {
    closeUserDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarUsuarios(); showInfoModal('Usuario eliminado correctamente.','¬°Usuario Eliminado!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando el usuario'); })
      .eliminarUsuario(deleteEmail);
  }

  // ------- Init & Listeners -------
  function init() {
    // Eventos generales
    qs('#btnInfoOk').addEventListener('click', hideInfoModal);
    qs('#infoOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) hideInfoModal(); });

    // Salas: botones
    qs('#btnAddSala').addEventListener('click', openSalaAddModal);
    qs('#btnEmptyAddSala').addEventListener('click', openSalaAddModal);
    qs('#btnSalaCancel').addEventListener('click', closeSalaEditModal);
    qs('#editSalaModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSalaEditModal(); });
    qs('#formEditSala').addEventListener('submit', submitSala);
    qs('#btnDeleteSalaCancel').addEventListener('click', closeSalaDeleteModal);
    qs('#deleteSalaOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeSalaDeleteModal(); });
    qs('#btnDeleteSalaOk').addEventListener('click', confirmDeleteSala);

    // Usuarios: botones
    qs('#btnAddUser').addEventListener('click', openUserAddModal);
    qs('#btnEmptyAddUser').addEventListener('click', openUserAddModal);
    qs('#btnUserCancel').addEventListener('click', closeUserEditModal);
    qs('#editUserModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserEditModal(); });
    qs('#formEditUser').addEventListener('submit', submitUser);
    qs('#btnDeleteUserCancel').addEventListener('click', closeUserDeleteModal);
    qs('#deleteUserOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserDeleteModal(); });
    qs('#btnDeleteUserOk').addEventListener('click', confirmDeleteUser);

    // Datos
    showTab('salas');
    cargarRoles();
    cargarSalas();
    cargarUsuarios();
  }

  // API p√∫blica (solo lo necesario desde HTML)
  return {
    init,
    showTab,
    openSalaEditModal,
    openSalaDeleteModal,
    openUserEditModal,
    openUserDeleteModal
  };
})();

// Arranque
document.addEventListener('DOMContentLoaded', () => PanelAdmin.init());
</script>
