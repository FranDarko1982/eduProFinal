<!-- =========================
     PANEL DE CONTROL
     ========================= -->
<div class="panel-admin-container">
  <h1 class="panel-admin-title">Panel de control</h1>
  <p class="panel-admin-desc">
    Administra las salas y los usuarios de la aplicaci√≥n
  </p>

  <!-- Tabs -->
  <div class="panel-admin-tabs">
    <button id="tab-salas" class="panel-admin-tab active" onclick="PanelAdmin.showTab('salas')">
      Editar salas
    </button>
    <button id="tab-usuarios" class="panel-admin-tab" onclick="PanelAdmin.showTab('usuarios')">
      Editar usuarios
    </button>
    <button id="tab-ciudades" class="panel-admin-tab" onclick="PanelAdmin.showTab('ciudades')">
      Editar ciudades
    </button>
    <button id="tab-centros" class="panel-admin-tab" onclick="PanelAdmin.showTab('centros')">
      Editar centros
    </button>
  </div>

  <!-- ======= Panel Salas ======= -->
  <div id="panel-salas" class="panel-admin-panel active">
    <div id="salasEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay salas</div>
        <div class="panel-admin-desc2">A√±ade una sala para empezar a gestionar las reservas</div>
      </div>
      <button id="btnEmptyAddSala" class="panel-admin-btn">A√±adir sala</button>
    </div>

    <div id="salasTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
        <button id="btnAddSala" class="panel-admin-btn" title="A√±adir sala">+</button>
      </div>
      <table id="panelSalasTable" class="table-style">
        <thead>
          <tr>
            <th>ID Sala</th>
            <th>Centro</th>
            <th>Ciudad</th>
            <th>Nombre</th>
            <th>Capacidad</th>
            <th>Equipamiento</th>
            <th>Observaciones</th>
            <th>Horario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ======= Panel Usuarios ======= -->
  <div id="panel-usuarios" class="panel-admin-panel">
    <div id="usuariosEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay usuarios</div>
        <div class="panel-admin-desc2">A√±ade un usuario para empezar a gestionar permisos y reservas</div>
      </div>
      <button id="btnEmptyAddUser" class="panel-admin-btn">A√±adir usuario</button>
    </div>

    <div id="usuariosTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;align-items:center;">
        <div>
          <input type="file" id="fileUploadUsuarios" />
          <button id="btnUploadUsuarios" class="panel-admin-btn" title="Importar usuarios desde Excel">Subir Excel</button>
        </div>
        <button id="btnAddUser" class="panel-admin-btn" title="A√±adir usuario">+</button>
      </div>
      <table id="usuariosTable" class="table-style">
        <thead>
          <tr>
            <th>Email</th>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Campa√±a</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ======= Panel Ciudades ======= -->
  <div id="panel-ciudades" class="panel-admin-panel">
    <div id="ciudadesEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay ciudades</div>
        <div class="panel-admin-desc2">A√±ade una ciudad para empezar a gestionar centros</div>
      </div>
      <button id="btnEmptyAddCiudad" class="panel-admin-btn">A√±adir ciudad</button>
    </div>
    <div id="ciudadesTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
        <button id="btnAddCiudad" class="panel-admin-btn" title="A√±adir ciudad">+</button>
      </div>
      <table id="ciudadesTable" class="table-style">
        <thead>
          <tr>
            <th>ID Ciudad</th>
            <th>Ciudad</th>
            <th>Imagen Ciudad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <input type="file" id="ciudadImageInput" accept="image/png" class="hidden" />
  </div>

  <!-- ======= Panel Centros ======= -->
  <div id="panel-centros" class="panel-admin-panel">
    <div id="centrosEmpty" class="panel-admin-center">
      <div>
        <div class="panel-admin-title2">No hay centros</div>
        <div class="panel-admin-desc2">A√±ade un centro para completar la informaci√≥n</div>
      </div>
      <button id="btnEmptyAddCentro" class="panel-admin-btn">A√±adir centro</button>
    </div>
    <div id="centrosTableContainer" class="salas-table-container hidden">
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
        <button id="btnAddCentro" class="panel-admin-btn" title="A√±adir centro">+</button>
      </div>
      <table id="centrosTable" class="table-style">
        <thead>
          <tr>
            <th>ID Centro</th>
            <th>Nombre Centro</th>
            <th>Direccion Centro</th>
            <th>Telefono</th>
            <th>Email</th>
            <th>Responsable</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ======= Modal editar/crear Usuario ======= -->
<div id="editUserModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Usuario</h2>
    <form id="formEditUser" autocomplete="off">
      <input id="userEmail" type="email" class="modal-reserva-input" placeholder="Email" required />
      <input id="userNombre" type="text" class="modal-reserva-input" placeholder="Nombre" />
      <select id="userRol" class="modal-reserva-input"></select>
      <input id="userCampania" type="text" class="modal-reserva-input" placeholder="Campa√±a" />
      <div class="modal-reserva-botones">
        <button type="button" id="btnUserCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnUserSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Usuario ======= -->
<div id="deleteUserOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Usuario</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteUserMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteUserCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteUserOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>

<!-- ======= Modal editar/crear Sala ======= -->
<div id="editSalaModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Sala</h2>
    <form id="formEditSala" autocomplete="off">
      <input id="salaId" type="text" class="modal-reserva-input" placeholder="ID Sala (opcional al crear)"/>
      <input id="salaCentro" type="text" class="modal-reserva-input" placeholder="Centro" required />
      <input id="salaCiudad" type="text" class="modal-reserva-input" placeholder="Ciudad" required />
      <input id="salaNombre" type="text" class="modal-reserva-input" placeholder="Nombre" required />
      <input id="salaCapacidad" type="number" class="modal-reserva-input" placeholder="Capacidad" />
      <input id="salaEquipamiento" type="text" class="modal-reserva-input" placeholder="Equipamiento" />
      <input id="salaObs" type="text" class="modal-reserva-input" placeholder="Observaciones" />
      <input id="salaHorario" type="text" class="modal-reserva-input" placeholder="Horario" />
      <div class="modal-reserva-botones">
        <button type="button" id="btnSalaCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnSalaSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Sala ======= -->
<div id="deleteSalaOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Sala</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteSalaMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteSalaCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteSalaOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>
<!-- ======= Modal editar/crear Ciudad ======= -->
<div id="editCiudadModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Ciudad</h2>
    <form id="formEditCiudad" autocomplete="off">
      <input id="ciudadId" type="text" class="modal-reserva-input" placeholder="ID Ciudad (opcional al crear)" />
      <input id="ciudadNombre" type="text" class="modal-reserva-input" placeholder="Nombre Ciudad" required />
      <div class="modal-reserva-botones">
        <button type="button" id="btnCiudadCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnCiudadSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Ciudad ======= -->
<div id="deleteCiudadOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Ciudad</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteCiudadMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteCiudadCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteCiudadOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>

<!-- ======= Modal editar/crear Centro ======= -->
<div id="editCentroModal" class="modal-reserva-bg">
  <div class="modal-reserva">
    <h2 class="modal-reserva-titulo">Editar Centro</h2>
    <form id="formEditCentro" autocomplete="off">
      <input id="centroId" type="text" class="modal-reserva-input" placeholder="ID Centro (opcional al crear)" />
      <input id="centroNombre" type="text" class="modal-reserva-input" placeholder="Nombre Centro" required />
      <input id="centroDireccion" type="text" class="modal-reserva-input" placeholder="Direcci√≥n Centro" />
      <input id="centroTelefono" type="number" class="modal-reserva-input" placeholder="Telefono" />
      <input id="centroEmail" type="email" class="modal-reserva-input" placeholder="Email" />
      <input id="centroResponsable" type="text" class="modal-reserva-input" placeholder="Responsable" />
      <div class="modal-reserva-botones">
        <button type="button" id="btnCentroCancel" class="modal-reserva-btn-cancelar">Cancelar</button>
        <button type="submit" id="btnCentroSave" class="modal-reserva-btn-guardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= Modal eliminar Centro ======= -->
<div id="deleteCentroOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div class="modal-header mb-2">Eliminar Centro</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="deleteCentroMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer" style="display:flex;gap:1rem;">
      <button id="btnDeleteCentroCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
      <button id="btnDeleteCentroOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
    </div>
  </div>
</div>

<!-- ======= Modal informaci√≥n reutilizable ======= -->
<div id="infoOverlay" class="modal-overlay" style="display:none;">
  <div class="modal flex-col">
    <div id="infoHeader" class="modal-header mb-2">Informaci√≥n</div>
    <div class="modal-body flex flex-col gap-3">
      <p id="infoMsg" class="text-[#0d151b]"></p>
    </div>
    <div class="modal-footer">
      <button id="btnInfoOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Aceptar</button>
    </div>
  </div>
</div>

<script>
/* Encapsulamos todo en un namespace para evitar ‚Äúalready been declared‚Äù */
const PanelAdmin = (() => {
  // ------- Estado interno -------
  let salasOriginales = [];
  let usuariosOriginales = [];
  let roles = [];
  let ciudadesOriginales = [];
  let centrosOriginales = [];
  let currentSalaId = null;   // null => creando
  let currentEmail = null;    // null => creando
  let currentCiudadId = null;
  let currentCiudadImageId = null;
  let currentCiudadImageName = '';
  let currentCentroId = null;
  let deleteSalaId = null;
  let deleteEmail = null;
  let deleteCiudadId = null;
  let deleteCentroId = null;

  // ------- Helpers -------
  const show = (el) => el.style.display = 'flex';
  const hide = (el) => el.style.display = 'none';
  const qs  = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));
  const safe = (v) => (v == null ? '' : v);

  function showInfoModal(msg, header='Informaci√≥n') {
    qs('#infoHeader').textContent = header;
    qs('#infoMsg').textContent = msg;
    show(qs('#infoOverlay'));
  }
  function hideInfoModal() { hide(qs('#infoOverlay')); }

  // ------- Tabs -------
  function showTab(tab) {
    qs('#tab-salas').classList.toggle('active', tab === 'salas');
    qs('#tab-usuarios').classList.toggle('active', tab === 'usuarios');
    qs('#tab-ciudades').classList.toggle('active', tab === 'ciudades');
    qs('#tab-centros').classList.toggle('active', tab === 'centros');
    qs('#panel-salas').classList.toggle('active', tab === 'salas');
    qs('#panel-usuarios').classList.toggle('active', tab === 'usuarios');
    qs('#panel-ciudades').classList.toggle('active', tab === 'ciudades');
    qs('#panel-centros').classList.toggle('active', tab === 'centros');
  }

  // ------- Cargar Salas -------
  function cargarSalas() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        console.log('getAllSalas ->', Array.isArray(d) ? d.length : d); // debug
        salasOriginales = Array.isArray(d) ? d : [];
        renderSalas(salasOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar las salas');
      })
      .getAllSalas();
  }

  function renderSalas(salas) {
    const empty  = qs('#salasEmpty');
    const tableC = qs('#salasTableContainer');
    const tbody  = qs('#panelSalasTable tbody');

    if (!salas || !salas.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';

    const cols = ['ID Sala','Centro','Ciudad','Nombre','Capacidad','Equipamiento','Observaciones','Horario'];

    salas.forEach(r => {
      const tr = document.createElement('tr');
      cols.forEach(k => {
        const td = document.createElement('td');
        td.textContent = safe(r[k]);
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      const id = safe(r['ID Sala']).toString().replace(/"/g,'&quot;');
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openSalaEditModal('${id}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openSalaDeleteModal('${id}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  // ------- Modales Sala -------
  function openSalaAddModal() {
    currentSalaId = null;
    qs('#editSalaModal h2').textContent = 'A√±adir Sala';
    qs('#salaId').value = '';
    qs('#salaCentro').value = '';
    qs('#salaCiudad').value = '';
    qs('#salaNombre').value = '';
    qs('#salaCapacidad').value = '';
    qs('#salaEquipamiento').value = '';
    qs('#salaObs').value = '';
    qs('#salaHorario').value = '';
    qs('#editSalaModal').classList.add('activo');
  }
  function openSalaEditModal(idSala) {
    const s = salasOriginales.find(x => String(x['ID Sala']) === String(idSala));
    if (!s) return;
    currentSalaId = String(idSala);
    qs('#editSalaModal h2').textContent = 'Editar Sala';
    qs('#salaId').value = safe(s['ID Sala']);
    qs('#salaCentro').value = safe(s['Centro']);
    qs('#salaCiudad').value = safe(s['Ciudad']);
    qs('#salaNombre').value = safe(s['Nombre']);
    qs('#salaCapacidad').value = safe(s['Capacidad']);
    qs('#salaEquipamiento').value = safe(s['Equipamiento']);
    qs('#salaObs').value = safe(s['Observaciones']);
    qs('#salaHorario').value = safe(s['Horario']);
    qs('#editSalaModal').classList.add('activo');
  }
  function closeSalaEditModal() { qs('#editSalaModal').classList.remove('activo'); }

  function submitSala(e) {
    e.preventDefault();
    const payload = {
      idSala:        qs('#salaId').value.trim(),
      Centro:        qs('#salaCentro').value.trim(),
      Ciudad:        qs('#salaCiudad').value.trim(),
      Nombre:        qs('#salaNombre').value.trim(),
      Capacidad:     qs('#salaCapacidad').value.trim(),
      Equipamiento:  qs('#salaEquipamiento').value.trim(),
      Observaciones: qs('#salaObs').value.trim(),
      Horario:       qs('#salaHorario').value.trim()
    };
    closeSalaEditModal();
    if (typeof showSpinner === 'function') showSpinner();

    const fn     = currentSalaId ? 'actualizarSala' : 'crearSala';
    const okHead = currentSalaId ? '¬°Sala Actualizada!' : '¬°Sala Creada!';
    const okMsg  = currentSalaId ? 'Sala actualizada correctamente.' : 'Sala creada correctamente.';
    const errMsg = currentSalaId ? 'Error actualizando la sala' : 'Error creando la sala';

    google.script.run
      .withSuccessHandler(() => { cargarSalas(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](payload);
  }

  // Borrado Sala
  function openSalaDeleteModal(idSala) {
    deleteSalaId = idSala;
    qs('#deleteSalaMsg').textContent = '¬øEliminar la sala ' + idSala + '?';
    show(qs('#deleteSalaOverlay'));
  }
  function closeSalaDeleteModal() { hide(qs('#deleteSalaOverlay')); }
  function confirmDeleteSala() {
    closeSalaDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarSalas(); showInfoModal('Sala eliminada correctamente.','¬°Sala Eliminada!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando la sala'); })
      .eliminarSala(deleteSalaId);
  }

  // ------- Ciudades -------
  function cargarCiudades() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        ciudadesOriginales = Array.isArray(d) ? d : [];
        renderCiudades(ciudadesOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar las ciudades');
      })
      .getAllCiudades();
  }

  function renderCiudades(list) {
    const empty  = qs('#ciudadesEmpty');
    const tableC = qs('#ciudadesTableContainer');
    const tbody  = qs('#ciudadesTable tbody');
    if (!list || !list.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';
    list.forEach(c => {
      const tr = document.createElement('tr');
      ['ID Ciudad','Ciudad','Imagen Ciudad'].forEach(k => {
        const td = document.createElement('td');
        const value = (k === 'Ciudad') ? (c['Ciudad'] || c['Nombre Ciudad']) : c[k];
        if (k === 'Imagen Ciudad') {
          const url = safe(c[k]);
          if (url) {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Ver imagen';
            td.appendChild(link);
          } else {
            td.textContent = '‚Äî';
          }
        } else {
          td.textContent = safe(c[k]);
        }
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      const id = safe(c['ID Ciudad']).toString().replace(/"/g,'&quot;');
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openCiudadImageDialog('${id}')" title="Cargar imagen">üñºÔ∏è</button>
        <button onclick="PanelAdmin.openCiudadEditModal('${id}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openCiudadDeleteModal('${id}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  function openCiudadAddModal() {
    currentCiudadId = null;
    qs('#editCiudadModal h2').textContent = 'A√±adir Ciudad';
    qs('#ciudadId').value = '';
    qs('#ciudadNombre').value = '';
    qs('#editCiudadModal').classList.add('activo');
  }
  function openCiudadEditModal(id) {
    const c = ciudadesOriginales.find(x => String(x['ID Ciudad']) === String(id));
    if (!c) return;
    currentCiudadId = String(id);
    qs('#editCiudadModal h2').textContent = 'Editar Ciudad';
    qs('#ciudadId').value = safe(c['ID Ciudad']);
    qs('#ciudadNombre').value = safe(c['Ciudad'] || c['Nombre Ciudad']);
    qs('#editCiudadModal').classList.add('activo');
  }
  function closeCiudadEditModal() { qs('#editCiudadModal').classList.remove('activo'); }

  function openCiudadImageDialog(id) {
    const ciudad = ciudadesOriginales.find(x => String(x['ID Ciudad']) === String(id));
    if (!ciudad) return;
    currentCiudadImageId = String(id);
    currentCiudadImageName = safe(ciudad['Nombre Ciudad']);
    const input = qs('#ciudadImageInput');
    if (!input) return;
    input.value = '';
    input.click();
  }

  function handleCiudadImageSelected(e) {
    const fileInput = e.target;
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;
    if (!currentCiudadImageId) {
      fileInput.value = '';
      return;
    }
  
    const mimeType = (file.type || 'image/png').toLowerCase();
    if (mimeType && !/^image\/(x-)?png$/.test(mimeType)) {
      alert('Solo se permiten im√°genes en formato PNG.');
      fileInput.value = '';
      currentCiudadImageId = null;
      currentCiudadImageName = '';
      return;
    }

    const reader = new FileReader();
    if (typeof showSpinner === 'function') showSpinner();
    reader.onload = function(ev) {
      try {
        const buffer = ev.target && ev.target.result;
        if (!(buffer instanceof ArrayBuffer)) throw new Error('Archivo inv√°lido');
        const bytes = Array.from(new Uint8Array(buffer));

        google.script.run
          .withSuccessHandler(() => {
            if (typeof hideSpinner === 'function') hideSpinner();
            currentCiudadImageId = null;
            currentCiudadImageName = '';
            fileInput.value = '';
            cargarCiudades();
            showInfoModal('Imagen de la ciudad actualizada correctamente.', '¬°Imagen actualizada!');
          })
          .withFailureHandler(err => {
            if (typeof hideSpinner === 'function') hideSpinner();
            currentCiudadImageId = null;
            currentCiudadImageName = '';
            fileInput.value = '';
            console.error(err);
            const msg = err && err.message ? err.message : err;
            alert('Error subiendo la imagen de la ciudad.' + (msg ? '\n\n' + msg : ''));
          })
          .uploadCiudadImagen({
            idCiudad: currentCiudadImageId,
            nombreCiudad: currentCiudadImageName,
            fileName: file.name,
            mimeType: mimeType,
            bytes: bytes
          });
      } catch (error) {
        if (typeof hideSpinner === 'function') hideSpinner();
        currentCiudadImageId = null;
        currentCiudadImageName = '';
        fileInput.value = '';
        console.error(error);
        alert('No se pudo leer el archivo seleccionado.');
      }
    };
    reader.onerror = function() {
      if (typeof hideSpinner === 'function') hideSpinner();
      currentCiudadImageId = null;
      currentCiudadImageName = '';
      fileInput.value = '';
      alert('No se pudo leer el archivo seleccionado.');
    };
    reader.readAsArrayBuffer(file);
  }

  function submitCiudad(e) {
    e.preventDefault();
    const payload = {
      idCiudad: qs('#ciudadId').value.trim(),
      'Ciudad': qs('#ciudadNombre').value.trim()
    };
    closeCiudadEditModal();
    if (typeof showSpinner === 'function') showSpinner();
    const fn = currentCiudadId ? 'actualizarCiudad' : 'crearCiudad';
    const okHead = currentCiudadId ? '¬°Ciudad Actualizada!' : '¬°Ciudad Creada!';
    const okMsg  = currentCiudadId ? 'Ciudad actualizada correctamente.' : 'Ciudad creada correctamente.';
    const errMsg = currentCiudadId ? 'Error actualizando la ciudad' : 'Error creando la ciudad';
    google.script.run
      .withSuccessHandler(() => { cargarCiudades(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](payload);
  }

  function openCiudadDeleteModal(id) {
    deleteCiudadId = id;
    qs('#deleteCiudadMsg').textContent = '¬øEliminar la ciudad ' + id + '?';
    show(qs('#deleteCiudadOverlay'));
  }
  function closeCiudadDeleteModal() { hide(qs('#deleteCiudadOverlay')); }
  function confirmDeleteCiudad() {
    closeCiudadDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarCiudades(); showInfoModal('Ciudad eliminada correctamente.','¬°Ciudad Eliminada!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando la ciudad'); })
      .eliminarCiudad(deleteCiudadId);
  }

  // ------- Centros -------
  function cargarCentros() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        centrosOriginales = Array.isArray(d) ? d : [];
        renderCentros(centrosOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar los centros');
      })
      .getAllCentros();
  }

  function renderCentros(list) {
    const empty  = qs('#centrosEmpty');
    const tableC = qs('#centrosTableContainer');
    const tbody  = qs('#centrosTable tbody');
    if (!list || !list.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';
    list.forEach(c => {
      const tr = document.createElement('tr');
      ['ID Centro','Nombre Centro','Direccion Centro','Telefono','Email','Responsable'].forEach(k => {
        const td = document.createElement('td');
        td.textContent = safe(c[k]);
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      const id = safe(c['ID Centro']).toString().replace(/"/g,'&quot;');
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openCentroEditModal('${id}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openCentroDeleteModal('${id}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  function openCentroAddModal() {
    currentCentroId = null;
    qs('#editCentroModal h2').textContent = 'A√±adir Centro';
    qs('#centroId').value = '';
    qs('#centroNombre').value = '';
    qs('#centroDireccion').value = '';
    qs('#centroTelefono').value = '';
    qs('#centroEmail').value = '';
    qs('#centroResponsable').value = '';
    qs('#editCentroModal').classList.add('activo');
  }
  function openCentroEditModal(id) {
    const c = centrosOriginales.find(x => String(x['ID Centro']) === String(id));
    if (!c) return;
    currentCentroId = String(id);
    qs('#editCentroModal h2').textContent = 'Editar Centro';
    qs('#centroId').value = safe(c['ID Centro']);
    qs('#centroNombre').value = safe(c['Nombre Centro']);
    qs('#centroDireccion').value = safe(c['Direccion Centro']);
    qs('#centroTelefono').value = safe(c['Telefono']);
    qs('#centroEmail').value = safe(c['Email']);
    qs('#centroResponsable').value = safe(c['Responsable']);
    qs('#editCentroModal').classList.add('activo');
  }
  function closeCentroEditModal() { qs('#editCentroModal').classList.remove('activo'); }

  function submitCentro(e) {
    e.preventDefault();
    const payload = {
      idCentro: qs('#centroId').value.trim(),
      'Nombre Centro': qs('#centroNombre').value.trim(),
      'Direccion Centro': qs('#centroDireccion').value.trim(),
      Telefono: qs('#centroTelefono').value.trim(),
      Email: qs('#centroEmail').value.trim(),
      Responsable: qs('#centroResponsable').value.trim()
    };
    closeCentroEditModal();
    if (typeof showSpinner === 'function') showSpinner();
    const fn = currentCentroId ? 'actualizarCentro' : 'crearCentro';
    const okHead = currentCentroId ? '¬°Centro Actualizado!' : '¬°Centro Creado!';
    const okMsg  = currentCentroId ? 'Centro actualizado correctamente.' : 'Centro creado correctamente.';
    const errMsg = currentCentroId ? 'Error actualizando el centro' : 'Error creando el centro';
    google.script.run
      .withSuccessHandler(() => { cargarCentros(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](payload);
  }

  function openCentroDeleteModal(id) {
    deleteCentroId = id;
    qs('#deleteCentroMsg').textContent = '¬øEliminar el centro ' + id + '?';
    show(qs('#deleteCentroOverlay'));
  }
  function closeCentroDeleteModal() { hide(qs('#deleteCentroOverlay')); }
  function confirmDeleteCentro() {
    closeCentroDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarCentros(); showInfoModal('Centro eliminado correctamente.','¬°Centro Eliminado!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando el centro'); })
      .eliminarCentro(deleteCentroId);
  }

  // ------- Usuarios -------
  function cargarUsuarios() {
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(d => {
        usuariosOriginales = Array.isArray(d) ? d : [];
        renderUsuarios(usuariosOriginales);
        if (typeof hideSpinner === 'function') hideSpinner();
      })
      .withFailureHandler(err => {
        if (typeof hideSpinner === 'function') hideSpinner();
        console.error(err); alert('Error al cargar los usuarios');
      })
      .getAllUsuarios();
  }

  function renderUsuarios(users) {
    const empty  = qs('#usuariosEmpty');
    const tableC = qs('#usuariosTableContainer');
    const tbody  = qs('#usuariosTable tbody');

    if (!users || !users.length) {
      empty.classList.remove('hidden');
      tableC.classList.add('hidden');
      return;
    }
    empty.classList.add('hidden');
    tableC.classList.remove('hidden');
    tbody.innerHTML = '';

    users.forEach(u => {
      const tr = document.createElement('tr');
      ['email','nombre','rol','Campa√±a'].forEach(k => {
        const td = document.createElement('td');
        td.textContent = safe(u[k]);
        tr.appendChild(td);
      });
      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      tdAct.innerHTML = `
        <button onclick="PanelAdmin.openUserEditModal('${u.email}')" title="Editar">‚úèÔ∏è</button>
        <button onclick="PanelAdmin.openUserDeleteModal('${u.email}')" title="Eliminar">üóëÔ∏è</button>
      `;
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });
  }

  function cargarRoles() {
    google.script.run.withSuccessHandler(list => {
      roles = Array.isArray(list) ? list : [];
    }).getRoles();
  }

  // Modales Usuario
  function openUserAddModal() {
    currentEmail = null;
    qs('#editUserModal h2').textContent = 'A√±adir Usuario';
    qs('#userEmail').value = '';
    qs('#userNombre').value = '';
    qs('#userCampania').value = '';
    const sel = qs('#userRol');
    sel.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
    sel.value = roles[0] || '';
    qs('#editUserModal').classList.add('activo');
  }
  function openUserEditModal(email) {
    const u = usuariosOriginales.find(x => x.email === email);
    if (!u) return;
    currentEmail = email;
    qs('#editUserModal h2').textContent = 'Editar Usuario';
    qs('#userEmail').value = safe(u.email);
    qs('#userNombre').value = safe(u.nombre);
    qs('#userCampania').value = safe(u['Campa√±a']);
    const sel = qs('#userRol');
    sel.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');
    sel.value = safe(u.rol);
    qs('#editUserModal').classList.add('activo');
  }
  function closeUserEditModal() { qs('#editUserModal').classList.remove('activo'); }

  function submitUser(e) {
    e.preventDefault();
    const data = {
      originalEmail: currentEmail,
      email:   qs('#userEmail').value.trim(),
      nombre:  qs('#userNombre').value.trim(),
      rol:     qs('#userRol').value,
      'Campa√±a': qs('#userCampania').value.trim()
    };
    closeUserEditModal();
    if (typeof showSpinner === 'function') showSpinner();

    const fn     = currentEmail ? 'actualizarUsuario' : 'crearUsuario';
    const okHead = currentEmail ? '¬°Usuario Actualizado!' : '¬°Usuario Creado!';
    const okMsg  = currentEmail ? 'Usuario actualizado correctamente.' : 'Usuario creado correctamente.';
    const errMsg = currentEmail ? 'Error actualizando el usuario' : 'Error creando el usuario';

    google.script.run
      .withSuccessHandler(() => { cargarUsuarios(); showInfoModal(okMsg, okHead); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert(errMsg); })
      [fn](data);
  }

  // Borrado Usuario
  function openUserDeleteModal(email) {
    deleteEmail = email;
    qs('#deleteUserMsg').textContent = '¬øEliminar el usuario ' + email + '?';
    show(qs('#deleteUserOverlay'));
  }
  function closeUserDeleteModal() { hide(qs('#deleteUserOverlay')); }
  function confirmDeleteUser() {
    closeUserDeleteModal();
    if (typeof showSpinner === 'function') showSpinner();
    google.script.run
      .withSuccessHandler(() => { cargarUsuarios(); showInfoModal('Usuario eliminado correctamente.','¬°Usuario Eliminado!'); })
      .withFailureHandler(err => { if (typeof hideSpinner === 'function') hideSpinner(); console.error(err); alert('Error eliminando el usuario'); })
      .eliminarUsuario(deleteEmail);
  }

  // ------- Importar Usuarios desde Excel -------

// Utilidades locales para spinner y modal
function showSpinner() {
  let spinner = document.getElementById('panel-spinner');
  if (!spinner) {
    spinner = document.createElement('div');
    spinner.id = 'panel-spinner';
    spinner.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;";
    spinner.innerHTML = '<div style="font-size:1.2em;color:#bc348b;font-weight:bold;">Cargando...</div>';
    document.body.appendChild(spinner);
  }
  spinner.style.display = 'flex';
}

function hideSpinner() {
  const spinner = document.getElementById('panel-spinner');
  if (spinner) spinner.style.display = 'none';
}

function showInfoModal(msg, title = "Aviso") {
  // Aqu√≠ puedes sustituir alert por un modal bonito si quieres
  alert(title + "\n\n" + msg);
}

function subirUsuarios() {
  const fileInput = qs('#fileUploadUsuarios');
  const file = fileInput.files[0];
  if (!file) { alert('Selecciona un archivo Excel primero'); return; }

  showSpinner();

  const fr = new FileReader();
  fr.onload = function(e) {
    const data = { name: file.name, content: [...new Int8Array(e.target.result)] };
    google.script.run
      .withSuccessHandler(msg => {
        hideSpinner();
        cargarUsuarios();
        showInfoModal(msg && msg.trim() ? msg : 'Usuarios importados correctamente.', '¬°Importaci√≥n exitosa!');
      })
      .withFailureHandler(err => {
        hideSpinner();
        showInfoModal('Error importando usuarios: ' + (err && err.message ? err.message : err), 'Error');
      })
      .importarUsuariosDesdeExcel(data);
  };

  fr.onerror = function() {
    hideSpinner();
    alert('Error leyendo el archivo');
  };

  fr.readAsArrayBuffer(file);
}

  // ------- Init & Listeners -------
  function init() {
    // Eventos generales
    qs('#btnInfoOk').addEventListener('click', hideInfoModal);
    qs('#infoOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) hideInfoModal(); });

    // Salas: botones
    qs('#btnAddSala').addEventListener('click', openSalaAddModal);
    qs('#btnEmptyAddSala').addEventListener('click', openSalaAddModal);
    qs('#btnSalaCancel').addEventListener('click', closeSalaEditModal);
    qs('#editSalaModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSalaEditModal(); });
    qs('#formEditSala').addEventListener('submit', submitSala);
    qs('#btnDeleteSalaCancel').addEventListener('click', closeSalaDeleteModal);
    qs('#deleteSalaOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeSalaDeleteModal(); });
    qs('#btnDeleteSalaOk').addEventListener('click', confirmDeleteSala);

    // Usuarios: botones
    qs('#btnAddUser').addEventListener('click', openUserAddModal);
    qs('#btnEmptyAddUser').addEventListener('click', openUserAddModal);
    qs('#btnUserCancel').addEventListener('click', closeUserEditModal);
    qs('#editUserModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserEditModal(); });
    qs('#formEditUser').addEventListener('submit', submitUser);
    qs('#btnDeleteUserCancel').addEventListener('click', closeUserDeleteModal);
    qs('#deleteUserOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserDeleteModal(); });
    qs('#btnDeleteUserOk').addEventListener('click', confirmDeleteUser);
    qs('#btnUploadUsuarios').addEventListener('click', subirUsuarios);

    // Ciudades: botones
    qs('#btnAddCiudad').addEventListener('click', openCiudadAddModal);
    qs('#btnEmptyAddCiudad').addEventListener('click', openCiudadAddModal);
    qs('#btnCiudadCancel').addEventListener('click', closeCiudadEditModal);
    qs('#editCiudadModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeCiudadEditModal(); });
    qs('#formEditCiudad').addEventListener('submit', submitCiudad);
    qs('#btnDeleteCiudadCancel').addEventListener('click', closeCiudadDeleteModal);
    qs('#deleteCiudadOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeCiudadDeleteModal(); });
    qs('#btnDeleteCiudadOk').addEventListener('click', confirmDeleteCiudad);
    const ciudadInput = qs('#ciudadImageInput');
    if (ciudadInput) ciudadInput.addEventListener('change', handleCiudadImageSelected);

    // Centros: botones
    qs('#btnAddCentro').addEventListener('click', openCentroAddModal);
    qs('#btnEmptyAddCentro').addEventListener('click', openCentroAddModal);
    qs('#btnCentroCancel').addEventListener('click', closeCentroEditModal);
    qs('#editCentroModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeCentroEditModal(); });
    qs('#formEditCentro').addEventListener('submit', submitCentro);
    qs('#btnDeleteCentroCancel').addEventListener('click', closeCentroDeleteModal);
    qs('#deleteCentroOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeCentroDeleteModal(); });
    qs('#btnDeleteCentroOk').addEventListener('click', confirmDeleteCentro);

    // Datos
    showTab('salas');
    cargarRoles();
    cargarSalas();
    cargarUsuarios();
    cargarCiudades();
    cargarCentros();
  }

  // API p√∫blica (solo lo necesario desde HTML)
  return {
    init,
    showTab,
    openSalaEditModal,
    openSalaDeleteModal,
    openUserEditModal,
    openUserDeleteModal,
    openCiudadEditModal,
    openCiudadImageDialog,
    openCiudadDeleteModal,
    openCentroEditModal,
    openCentroDeleteModal
  };
})();

// Arranque
document.addEventListener('DOMContentLoaded', () => PanelAdmin.init());
</script>
