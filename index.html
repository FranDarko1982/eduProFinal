<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Training Room Booking</title>

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
    <!-- Google Icons (para los iconos del sidebar) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;700" rel="stylesheet">

    <?!= include('styles'); ?>
    <?!= include('calendar-styles'); ?>

    <style>
      .main-header {
        background-color: #fff;
        padding: 1.5rem 2rem;
        box-shadow: 0 6px 18px rgba(12, 30, 58, 0.08);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: clamp(0.75rem, 2vw, 1.25rem);
        width: 100%;
        box-sizing: border-box;
      }

      .main-header .header-logo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      .main-header .header-logo-intelcia {
        display: block;
        height: clamp(48px, 9vw, 72px);
        width: auto;
        flex-shrink: 0;
        background-color: #fff;
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(12, 30, 58, 0.08);
      }

      .main-header .header-text {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: flex-start;
        text-align: left;
      }

      .main-header .header-text h1,
      .main-header .header-text p {
        margin: 0;
      }

      @media (max-width: 768px) {
        .main-header {
          padding: 1.25rem;
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .main-header .header-logo {
          width: 100%;
          justify-content: flex-start;
        }

        .main-header .header-logo-intelcia {
          height: 56px;
          padding: 0.35rem 0.65rem;
        }
      }
    </style>

    <script>
      window.USER_ROLE  = '<?= usuario.rol ?>'.toLowerCase();
      window.USER_EMAIL = '<?= getActiveUserEmail() ?>';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  </head>
  <body>
    <!-- CABECERA MODERNA -->
    <header class="main-header">
      <div class="header-logo">
        <img src="https://drive.google.com/thumbnail?sz=w500&id=1GYY7By40ONvXxl5qX4FSpaMqts8reoPy"
             alt="Intelcia"
             class="header-logo-intelcia" />
      </div>
      <div class="header-text">
        <h1>Reserva Salas de Formación</h1>
        <p>Consulta la disponibilidad de salas y reserva</p>
      </div>
    </header>

    <!-- NAV -> Sidebar de iconos -->
    <nav class="sidebar-icons tabs" id="mainTabs" aria-label="Navegación principal">
      <button class="tab active" data-id="inicio" data-visible="admin,usuario,manager" title="Inicio" aria-label="Inicio">
        <span class="material-symbols-outlined">home</span>
      </button>

      <button class="tab" data-id="calendar" data-visible="admin,usuario" title="Calendario" aria-label="Calendario">
        <span class="material-symbols-outlined">calendar_month</span>
      </button>

      <button class="tab" data-id="mybookings" data-visible="usuario" title="Mis reservas" aria-label="Mis reservas">
        <span class="material-symbols-outlined">checklist</span>
      </button>

      <button class="tab" data-id="reservas" data-visible="admin" title="Reservas" aria-label="Reservas">
        <span class="material-symbols-outlined">task_alt</span>
      </button>

      <button class="tab" data-id="rooms" data-visible="admin,usuario" title="Salas" aria-label="Salas">
        <span class="material-symbols-outlined">apartment</span>
      </button>

      <button class="tab" data-id="disponibilidad" data-visible="admin,usuario" title="Buscar disponibilidad" aria-label="Buscar disponibilidad">
        <span class="material-symbols-outlined">search</span>
      </button>

      <button class="tab" data-id="reports" data-visible="admin" title="Informes" aria-label="Informes">
        <span class="material-symbols-outlined">insights</span>
      </button>

      <button class="tab" data-id="reportes" data-visible="admin" title="Reportes" aria-label="Reportes">
        <span class="material-symbols-outlined">description</span>
      </button>

      <button class="tab" data-id="ayuda" data-visible="admin,usuario" title="Ayuda" aria-label="Ayuda">
        <span class="material-symbols-outlined">help</span>
      </button>

      <button class="tab" data-id="panel" data-visible="admin" title="Panel de control" aria-label="Panel de control">
        <span class="material-symbols-outlined">settings</span>
      </button>

      <div class="sidebar-sep" aria-hidden="true"></div>

      <!-- Iconos extra -->
      <a href="#notificaciones" class="icon-button" aria-label="Notificaciones" title="Notificaciones">
        <span class="material-symbols-outlined">notifications</span>
      </a>

      <div class="sidebar-spacer" aria-hidden="true"></div>

      <a href="#profile" class="icon-button icon-user" aria-label="Perfil usuario" title="<?= getActiveUserEmail() ?>">
        <span class="material-symbols-outlined">account_circle</span>
      </a>
    </nav>

    <main class="content">
      <section id="inicio"           class="section"><?!= include('inicio'); ?></section>
      <section id="calendar"         class="section"><?!= include('calendario'); ?></section>
      <section id="mybookings"       class="section"><?!= include('misreservas'); ?></section>
      <section id="reservas"         class="section"><?!= include('reservas'); ?></section>
      <section id="rooms"            class="section"><?!= include('salas'); ?></section>
      <section id="disponibilidad"   class="section"><?!= include('disponibilidad'); ?></section>
      <section id="reports"          class="section"><?!= include('informes'); ?></section>
      <section id="reportes"         class="section"><?!= include('Reportes'); ?></section>
      <section id="ayuda"            class="section"><?!= include('ayuda'); ?></section>
      <section id="panel"            class="section"><?!= include('panelcontrol'); ?></section>
      <section id="notificaciones"   class="section"><?!= include('notificaciones'); ?></section>
      <section id="profile"          class="section"><?!= include('usuario'); ?></section>
    </main>

    <!-- SPINNER GLOBAL -->
    <div id="spinnerOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-75 hidden">
      <div class="w-12 h-12 border-4 border-[#bc348b] border-t-transparent rounded-full animate-spin mb-2"></div>
      <div class="text-[#bc348b] font-medium">Cargando…</div>
    </div>

    <!-- ====== JS ====== -->
    <script>
      // Ajustar --header-h a la altura real de la cabecera (evita que el sidebar la pise)
      document.addEventListener('DOMContentLoaded', () => {
        const hdr = document.querySelector('.main-header');
        if (hdr) {
          const h = hdr.getBoundingClientRect().height;
          document.documentElement.style.setProperty('--header-h', h + 'px');
        }
      });

      // ---- util ----
      function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

      // Bandera para no re-inicializar el calendario
      window.__CAL_INITED = false;

      // Inicializa si hace falta y, siempre que muestres la sección, fuerza size/render
      function initOrResizeCalendar(){
        try {
          if (!window.__CAL_INITED) {
            if (typeof initCalendar === 'function') {         
              initCalendar();
              window.__CAL_INITED = true;
            } else if (window.Calendar && typeof window.Calendar.init === 'function') {
              window.Calendar.init();
              window.__CAL_INITED = true;
            }
          }
          const cal =
            window.calendar ||
            (window.Calendar && window.Calendar.instance) ||
            null;

          requestAnimationFrame(() => {
            if (cal && typeof cal.updateSize === 'function') cal.updateSize();
            if (cal && typeof cal.render === 'function')     cal.render();
            window.dispatchEvent(new Event('resize'));
          });
        } catch (e) {
          console.error('initOrResizeCalendar error:', e);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        const userRole = window.USER_ROLE;

        // 1) Mostrar/ocultar tabs según rol
        qsa('.tab').forEach(btn => {
          const vis = btn.getAttribute('data-visible');
          if (vis === 'all' || (vis && vis.split(',').map(r => r.trim().toLowerCase()).includes(userRole))) {
            btn.style.display = '';
          } else {
            btn.style.display = 'none';
          }
        });

        // 2) Ocultar secciones sin tab visible
        qsa('.section').forEach(sec => {
          const menuTab = document.querySelector(`.tab[data-id="${sec.id}"]`);
          if (!menuTab || menuTab.style.display === 'none') {
            sec.style.display = 'none';
          }
        });

        // 3) Mostrar la sección activa o la primera visible
        let found = false;
        qsa('.tab').forEach(btn => {
          if (!found && btn.classList.contains('active') && btn.style.display !== 'none') {
            showSection(btn);
            found = true;
          }
        });
        if (!found) {
          const first = qsa('.tab').find(l => l.style.display !== 'none');
          if (first) { first.classList.add('active'); showSection(first); }
        }

        // 4) Click en las tabs
        qsa('.tab').forEach(btn => {
          btn.addEventListener('click', e => {
            e.preventDefault();
            qsa('.tab').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            showSection(btn);

            const id = btn.getAttribute('data-id');
            if (id === 'mybookings' && typeof loadMisReservas === 'function') {
              loadMisReservas();
            }
            if (id === 'inicio' && window.Dashboard && typeof Dashboard.init === 'function') {
              Dashboard.init();
            }
            if (id === 'calendar') {
              initOrResizeCalendar();
            }
          });
        });

        function showSection(tabBtn) {
          const target = tabBtn.getAttribute('data-id');
          showSectionById(target);
          if (target === 'calendar') initOrResizeCalendar();
        }

        function showSectionById(id) {
          qsa('.section').forEach(sec => {
            sec.style.display = (sec.id === id ? 'block' : 'none');
          });
        }

        // Perfil de usuario
        const iconUser = document.querySelector('.icon-user');
        if (iconUser) {
          iconUser.addEventListener('click', e => {
            e.preventDefault();
            qsa('.tab').forEach(l => l.classList.remove('active'));
            showSectionById('profile');
            if (typeof UserApp !== 'undefined') {
              UserApp.loadProfile();
              UserApp.loadActivity();
              UserApp.loadMetrics();
              UserApp.loadFavoritos();
            }
          });
        }

        // Notificaciones (solo admin)
        const btnNotif = document.querySelector('.icon-button[aria-label="Notificaciones"]');
        if (userRole === 'admin') {
          if (btnNotif) {
            btnNotif.addEventListener('click', e => {
              e.preventDefault();
              qsa('.tab').forEach(l => l.classList.remove('active'));
              showSectionById('notificaciones');
              if (typeof NotificationsApp !== 'undefined') {
                NotificationsApp.init();
              }
            });
          }
        } else {
          if (btnNotif) btnNotif.style.display = 'none';
          const secNotif = document.getElementById('notificaciones');
          if (secNotif) secNotif.remove();
        }

        const tienesNotificaciones = false;
        if (tienesNotificaciones && btnNotif) {
          btnNotif.classList.add('has-notifications');
        }
      });
    </script>

  </body>
</html>
