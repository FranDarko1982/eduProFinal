<!-- salas.html -->

<div class="salas-filters">
  <div class="filter-style">
    <div class="filter">
      <label for="salas-filter-city">Ciudad:</label>
      <select id="salas-filter-city">
        <option value="">— Elige Ciudad —</option>
      </select>
    </div>
    <div class="filter">
      <label for="salas-filter-center">Centro:</label>
      <select id="salas-filter-center">
        <option value="">— Elige Centro —</option>
      </select>
    </div>
    <div class="filter">
      <label for="salas-filter-room">Sala:</label>
      <select id="salas-filter-room">
        <option value="">— Elige Sala —</option>
      </select>
    </div>
    <button type="button" id="salas-clear-filters" class="btn-filters-clear">Quitar filtros</button>
  </div>
  <div id="activeFilters" class="active-filters"></div>
</div>

<div id="salas-counter" class="salas-counter"></div>
<div id="salas-skeleton" class="salas-grid"></div>
<div id="salas-cards" class="salas-grid hidden" aria-live="polite"></div>
<div id="salas-empty" class="salas-empty hidden">
  No hay salas que coincidan.
  <button type="button" class="button-destacado" id="salas-empty-clear">Quitar filtros</button>
</div>

<script>
  const userRole = (window.USER_ROLE || '').toLowerCase();
  let salasOriginales = [];

  document.addEventListener('DOMContentLoaded', () => {
    showSkeletons(4);
    google.script.run
      .withSuccessHandler(salas => {
        salasOriginales = Array.isArray(salas) ? salas : [];
        cargarCiudades();
        cargarFiltersFromQuery();
        renderCards();
      })
      .withFailureHandler(err => {
        console.error(err);
        document.getElementById('salas-skeleton').classList.add('hidden');
        document.getElementById('salas-empty').classList.remove('hidden');
      })
      .getAllSalas();

    document.getElementById('salas-filter-city').addEventListener('change', () => {
      cargarCentros();
      cargarSalas();
      renderCards();
    });
    document.getElementById('salas-filter-center').addEventListener('change', () => {
      cargarSalas();
      renderCards();
    });
    document.getElementById('salas-filter-room').addEventListener('change', renderCards);
    document.getElementById('salas-clear-filters').addEventListener('click', limpiarFiltros);
    document.getElementById('salas-empty-clear').addEventListener('click', limpiarFiltros);
  });

  function showSkeletons(n) {
    const cont = document.getElementById('salas-skeleton');
    cont.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const sk = document.createElement('div');
      sk.className = 'card sala-skeleton';
      cont.appendChild(sk);
    }
  }

  function cargarCiudades() {
    const sel = document.getElementById('salas-filter-city');
    sel.innerHTML = '<option value="">— Elige Ciudad —</option>';
    const ciudades = [...new Set(
      salasOriginales.map(r => String(r.Ciudad || '').trim()).filter(v => v)
    )].sort();
    ciudades.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  function cargarCentros() {
    const ciudad = document.getElementById('salas-filter-city').value;
    const sel = document.getElementById('salas-filter-center');
    sel.innerHTML = '<option value="">— Elige Centro —</option>';
    let datos = salasOriginales;
    if (ciudad) datos = datos.filter(r => String(r.Ciudad).trim() === ciudad);
    const centros = [...new Set(
      datos.map(r => String(r.Centro || '').trim()).filter(v => v)
    )].sort();
    centros.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  function cargarSalas() {
    const ciudad = document.getElementById('salas-filter-city').value;
    const centro = document.getElementById('salas-filter-center').value;
    const sel = document.getElementById('salas-filter-room');
    sel.innerHTML = '<option value="">— Elige Sala —</option>';
    let datos = salasOriginales;
    if (ciudad) datos = datos.filter(r => String(r.Ciudad).trim() === ciudad);
    if (centro) datos = datos.filter(r => String(r.Centro).trim() === centro);
    const salas = [...new Set(
      datos.map(r => String(r.Nombre || '').trim()).filter(v => v)
    )].sort();
    salas.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });
  }

  function cargarFiltersFromQuery() {
    const params = new URLSearchParams(location.search);
    const ciudad = params.get('ciudad') || '';
    const centro = params.get('centro') || '';
    const sala = params.get('sala') || '';
    document.getElementById('salas-filter-city').value = ciudad;
    cargarCentros();
    document.getElementById('salas-filter-center').value = centro;
    cargarSalas();
    document.getElementById('salas-filter-room').value = sala;
  }

  function persistFilters() {
    const { ciudad, centro, sala } = getSelectedFilters();
    const params = new URLSearchParams(location.search);
    ciudad ? params.set('ciudad', ciudad) : params.delete('ciudad');
    centro ? params.set('centro', centro) : params.delete('centro');
    sala ? params.set('sala', sala) : params.delete('sala');
    const qs = params.toString();
    history.replaceState(null, '', qs ? `?${qs}` : location.pathname);
  }

  function getSelectedFilters() {
    return {
      ciudad: document.getElementById('salas-filter-city').value,
      centro: document.getElementById('salas-filter-center').value,
      sala: document.getElementById('salas-filter-room').value
    };
  }

  function limpiarFiltros() {
    document.getElementById('salas-filter-city').value = '';
    cargarCentros();
    document.getElementById('salas-filter-center').value = '';
    cargarSalas();
    document.getElementById('salas-filter-room').value = '';
    renderCards();
  }

  function updateChips() {
    const { ciudad, centro, sala } = getSelectedFilters();
    const cont = document.getElementById('activeFilters');
    cont.innerHTML = '';
    const addChip = (label, field, value) => {
      const chip = document.createElement('span');
      chip.className = 'filter-chip';
      chip.textContent = `${label}: ${value}`;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = '×';
      btn.addEventListener('click', () => {
        if (field === 'ciudad') {
          document.getElementById('salas-filter-city').value = '';
          cargarCentros();
          document.getElementById('salas-filter-center').value = '';
          cargarSalas();
          document.getElementById('salas-filter-room').value = '';
        }
        if (field === 'centro') {
          document.getElementById('salas-filter-center').value = '';
          cargarSalas();
          document.getElementById('salas-filter-room').value = '';
        }
        if (field === 'sala') {
          document.getElementById('salas-filter-room').value = '';
        }
        renderCards();
      });
      chip.appendChild(btn);
      cont.appendChild(chip);
    };
    if (ciudad) addChip('Ciudad', 'ciudad', ciudad);
    if (centro) addChip('Centro', 'centro', centro);
    if (sala) addChip('Sala', 'sala', sala);
  }

  function renderCards() {
    persistFilters();
    updateChips();
    const { ciudad, centro, sala } = getSelectedFilters();
    const cont = document.getElementById('salas-cards');
    let datos = salasOriginales.slice();
    if (ciudad) datos = datos.filter(r => String(r.Ciudad).trim() === ciudad);
    if (centro) datos = datos.filter(r => String(r.Centro).trim() === centro);
    if (sala) datos = datos.filter(r => String(r.Nombre).trim() === sala);
    datos = datos.filter(r => String(r.Activo) === '1' || userRole === 'admin');
    const counter = document.getElementById('salas-counter');
    counter.textContent = datos.length ? `${datos.length} sala${datos.length !== 1 ? 's' : ''}` : '';
    cont.innerHTML = '';
    if (!datos.length) {
      document.getElementById('salas-skeleton').classList.add('hidden');
      cont.classList.add('hidden');
      document.getElementById('salas-empty').classList.remove('hidden');
      return;
    }
    document.getElementById('salas-empty').classList.add('hidden');
    document.getElementById('salas-skeleton').classList.add('hidden');
    cont.classList.remove('hidden');
    datos.forEach(s => cont.appendChild(crearCard(s)));
  }

  function crearCard(s) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.setAttribute('aria-expanded', 'false');

    const head = document.createElement('div');
    head.className = 'card-head';
    const h3 = document.createElement('h3');
    h3.textContent = s.Nombre || '—';
    head.appendChild(h3);
    const badgeWrap = document.createElement('div');
    badgeWrap.className = 'sala-badges';
    const cap = document.createElement('span');
    cap.className = 'sala-badge';
    cap.textContent = 'Capacidad ' + (s.Capacidad || '—');
    badgeWrap.appendChild(cap);
    if (s.Equipamiento) {
      const eq = document.createElement('span');
      eq.className = 'sala-badge';
      eq.textContent = s.Equipamiento;
      badgeWrap.appendChild(eq);
    }
    head.appendChild(badgeWrap);
    card.appendChild(head);

    const info = document.createElement('p');
    info.className = 'sala-info';
    info.textContent = `${s.Centro || '—'} · ${s.Ciudad || '—'}`;
    card.appendChild(info);

    const horario = document.createElement('p');
    horario.className = 'sala-horario';
    horario.textContent = 'Horario: ' + (s.Horario || '—');
    card.appendChild(horario);

    const actions = document.createElement('div');
    actions.className = 'sala-actions';
    const btnVer = document.createElement('button');
    btnVer.className = 'button-destacado';
    btnVer.textContent = 'Ver disponibilidad';
    btnVer.addEventListener('click', e => {
      e.stopPropagation();
      verDisponibilidad(s);
    });
    actions.appendChild(btnVer);
    if (userRole === 'admin') {
      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Modificar';
      btnEdit.addEventListener('click', e => {
        e.stopPropagation();
        editarSala(s);
      });
      actions.appendChild(btnEdit);
    }
    card.appendChild(actions);

    const details = document.createElement('div');
    details.className = 'sala-detalles';
    const obs = document.createElement('p');
    obs.textContent = s.Observaciones || '—';
    details.appendChild(obs);
    card.appendChild(details);

    card.addEventListener('click', () => toggleCard(card));
    card.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleCard(card);
      }
    });
    return card;
  }

  function toggleCard(card) {
    const exp = card.classList.toggle('expanded');
    card.setAttribute('aria-expanded', exp ? 'true' : 'false');
  }

  function verDisponibilidad(s) {
    const params = new URLSearchParams(location.search);
    params.set('sala', s.Nombre);
    history.replaceState(null, '', location.pathname + '?' + params.toString());
    const tab = document.querySelector('.tab[data-id="calendar"]');
    if (tab) tab.click();
  }

  function editarSala(s) {
    if (window.PanelAdmin && typeof PanelAdmin.openSalaEditModal === 'function') {
      PanelAdmin.openSalaEditModal(s['ID Sala']);
    }
  }
</script>
