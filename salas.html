<!-- salas.html -->

<button id="salas-back" class="hidden btn-back">← Volver</button>

<div id="salas-skeleton" class="salas-grid"></div>

<div id="salas-cities" class="salas-grid hidden" aria-live="polite"></div>
<div id="salas-centers" class="salas-grid hidden" aria-live="polite"></div>

<div id="salas-layout" class="salas-layout hidden">
  <div id="salas-rooms" class="salas-grid salas-rooms"></div>
  <div id="salas-info" class="sala-info-panel">
    <img id="salas-plan" class="sala-plan hidden" alt="Plano" />
    <div id="salas-info-text" class="sala-info-text"></div>
  </div>
</div>

<div id="salas-empty" class="salas-empty hidden">No hay datos.</div>

<script>
  const userRole = (window.USER_ROLE || '').toLowerCase();
  let salasOriginales = [];
  let current = { ciudad: null, centro: null, sala: null };
  let currentRooms = [];

  document.addEventListener('DOMContentLoaded', () => {
    showSkeletons(4);
    google.script.run
      .withSuccessHandler(salas => {
        salasOriginales = Array.isArray(salas) ? salas : [];
        renderCities();
      })
      .withFailureHandler(err => {
        console.error(err);
        document.getElementById('salas-skeleton').classList.add('hidden');
        document.getElementById('salas-empty').classList.remove('hidden');
      })
      .getAllSalas();

    document.getElementById('salas-back').addEventListener('click', handleBack);
  });

  function showSkeletons(n) {
    const cont = document.getElementById('salas-skeleton');
    cont.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const sk = document.createElement('div');
      sk.className = 'card sala-skeleton';
      cont.appendChild(sk);
    }
  }

  function handleBack() {
    if (current.sala) {
      current.sala = null;
      renderSalaInfo(null);
    } else if (current.centro) {
      current.centro = null;
      renderCentros();
    } else if (current.ciudad) {
      current.ciudad = null;
      renderCities();
    }
  }

  function renderCities() {
    const cont = document.getElementById('salas-cities');
    cont.innerHTML = '';
    const ciudades = [...new Set(
      salasOriginales.map(r => String(r.Ciudad || '').trim()).filter(v => v)
    )].sort();
    ciudades.forEach(c => cont.appendChild(crearSimpleCard(c, () => {
      current.ciudad = c;
      renderCentros();
    })));
    toggleViews('cities');
  }

  function renderCentros() {
    const cont = document.getElementById('salas-centers');
    cont.innerHTML = '';
    const centros = [...new Set(
      salasOriginales
        .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
        .map(r => String(r.Centro || '').trim()).filter(v => v)
    )].sort();
    centros.forEach(c => cont.appendChild(crearSimpleCard(c, () => {
      current.centro = c;
      renderSalas();
    })));
    toggleViews('centers');
  }

  function renderSalas() {
    const cont = document.getElementById('salas-rooms');
    cont.innerHTML = '';
    currentRooms = salasOriginales
      .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
      .filter(r => String(r.Centro || '').trim() === current.centro)
      .filter(r => String(r.Activo) === '1' || userRole === 'admin');

    currentRooms.forEach(s => cont.appendChild(crearSalaCard(s)));
    renderSalaInfo(null);
    toggleViews('rooms');
  }

  function renderSalaInfo(s) {
    const img = document.getElementById('salas-plan');
    const info = document.getElementById('salas-info-text');
    document.querySelectorAll('#salas-rooms .sala-card').forEach(card => {
      card.classList.toggle('selected', s && card.dataset.name === s.Nombre);
    });
    if (s) {
      current.sala = s.Nombre;
      if (s.MapaSala || s['Mapa Sala']) {
        img.src = s.MapaSala || s['Mapa Sala'];
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      info.textContent = s.Observaciones || '';
    } else {
      current.sala = null;
      const base = currentRooms[0] || {};
      const plano = base.UbicacionCentro || base.PlanoCentro || base['Ubicacion Centro'] || '';
      if (plano) {
        img.src = plano;
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      info.textContent = base.InformacionCentro || base.InfoCentro || base['Informacion Centro'] || '';
    }
  }

  function crearSimpleCard(text, onClick) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    const h3 = document.createElement('h3');
    h3.textContent = text;
    card.appendChild(h3);
    card.addEventListener('click', onClick);
    return card;
  }

  function crearSalaCard(s) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    card.dataset.name = s.Nombre;

    const head = document.createElement('div');
    head.className = 'card-head';
    const h3 = document.createElement('h3');
    h3.textContent = s.Nombre || '—';
    head.appendChild(h3);
    const badges = document.createElement('div');
    badges.className = 'sala-badges';
    const cap = document.createElement('span');
    cap.className = 'sala-badge';
    cap.textContent = 'Capacidad ' + (s.Capacidad || '—');
    badges.appendChild(cap);
    if (s.Equipamiento) {
      const eq = document.createElement('span');
      eq.className = 'sala-badge';
      eq.textContent = s.Equipamiento;
      badges.appendChild(eq);
    }
    head.appendChild(badges);
    card.appendChild(head);

    card.addEventListener('click', () => renderSalaInfo(s));
    return card;
  }

  function toggleViews(view) {
    document.getElementById('salas-skeleton').classList.add('hidden');
    document.getElementById('salas-back').classList.toggle('hidden', view === 'cities');
    document.getElementById('salas-empty').classList.add('hidden');
    document.getElementById('salas-cities').classList.toggle('hidden', view !== 'cities');
    document.getElementById('salas-centers').classList.toggle('hidden', view !== 'centers');
    document.getElementById('salas-layout').classList.toggle('hidden', view !== 'rooms');
    if (view !== 'rooms') current.sala = null;
    if (view !== 'centers') current.centro = view === 'rooms' ? current.centro : null;
  }
</script>
