<!-- salas.html -->

<button id="salas-back" class="hidden btn-back">← Volver</button>

<div id="salas-skeleton" class="salas-grid"></div>

<div id="salas-cities" class="salas-grid hidden" aria-live="polite"></div>
<div id="salas-centers" class="salas-centers-layout hidden" aria-live="polite">
  <div id="salas-centers-list" class="salas-centers-list"></div>
  <div class="salas-centers-divider" role="presentation" aria-hidden="true"></div>
  <div id="salas-city-visual" class="salas-city-visual">
    <img id="salas-city-image" class="salas-city-image hidden" alt="Mapa de centros de la ciudad" />
    <div id="salas-city-image-empty" class="salas-city-image-empty">No hay imagen disponible para esta ciudad.</div>
  </div>
</div>

<div id="salas-layout" class="salas-layout hidden">
  <div id="salas-rooms" class="salas-grid salas-rooms"></div>
  <div id="salas-info" class="sala-info-panel">
    <img id="salas-plan" class="sala-plan hidden" alt="Plano" />
    <div id="salas-info-text" class="sala-info-text"></div>
  </div>
</div>

<div id="salas-empty" class="salas-empty hidden">No hay datos.</div>

<script>
  const userRole = (window.USER_ROLE || '').toLowerCase();
  let salasOriginales = [];
  let centrosInfo = {};
  let ciudadesInfo = Object.create(null);
  let current = { ciudad: null, centro: null, sala: null };
  let currentRooms = [];

  const CENTER_ICONS = {
    ubicacion: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=12T2BaLFqegpXg0oJmEixxe3t9HJdHDaM',
      alt: 'Dirección del centro'
    },
    telefono: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1XZ5SQVTZGMqd2vv8P8OzAPhZsRwG_9Rh',
      alt: 'Teléfono del centro'
    },
    email: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=17P7Zvt0mc-Zl-5FVEfpwFw0Q9EU6_QET',
      alt: 'Correo electrónico del centro'
    },
    responsable: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1pIojlguVE1hxt3ftk1YqIRUwYxLzOvsP',
      alt: 'Responsable del centro'
    }
  };

  function normalizarClaveCiudad(valor) {
    if (!valor) return '';
    let texto = String(valor).trim().toLowerCase();
    if (typeof String.prototype.normalize === 'function') {
      try {
        return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (error) {
        // Si falla seguimos con la aproximación manual de abajo.
      }
    }
    return texto
      .replace(/[áàäâãå]/g, 'a')
      .replace(/[éèëê]/g, 'e')
      .replace(/[íìïî]/g, 'i')
      .replace(/[óòöôõ]/g, 'o')
      .replace(/[úùüû]/g, 'u')
      .replace(/ñ/g, 'n')
      .replace(/ç/g, 'c');
  }

  function guardarCiudadInfo(nombre, datos) {
    if (!nombre) return;
    ciudadesInfo[nombre] = datos;
    const clave = normalizarClaveCiudad(nombre);
    if (clave && clave !== nombre) {
      ciudadesInfo[clave] = datos;
    }
  }

  function obtenerCiudadInfo(nombre) {
    if (!nombre) return null;
    return ciudadesInfo[nombre] || ciudadesInfo[normalizarClaveCiudad(nombre)] || null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    showSkeletons(4);
    cargarCiudades();
    document.getElementById('salas-back').addEventListener('click', handleBack);
  });

  function cargarCiudades() {
    google.script.run
      .withSuccessHandler(ciudades => {
        ciudadesInfo = Object.create(null);
        (Array.isArray(ciudades) ? ciudades : []).forEach(c => {
          const nombre = String(
            c['Ciudad'] ||
            c['Nombre Ciudad'] ||
            c.NombreCiudad ||
            c.Nombre ||
            ''
          ).trim();
          if (nombre) guardarCiudadInfo(nombre, c);
        });
        cargarCentros();
      })
      .withFailureHandler(handleLoadError)
      .getAllCiudades();
  }

  function cargarCentros() {
    google.script.run
      .withSuccessHandler(centros => {
        centrosInfo = {};
        (Array.isArray(centros) ? centros : []).forEach(c => {
          const nombre = String(c['Nombre Centro'] || c.NombreCentro || c.Nombre || '').trim();
          if (nombre) centrosInfo[nombre] = c;
        });
        cargarSalas();
      })
      .withFailureHandler(handleLoadError)
      .getAllCentros();
  }

  function cargarSalas() {
    google.script.run
      .withSuccessHandler(salas => {
        salasOriginales = Array.isArray(salas) ? salas : [];
        renderCities();
      })
      .withFailureHandler(handleLoadError)
      .getAllSalas();
  }

  function handleLoadError(err) {
    console.error(err);
    document.getElementById('salas-skeleton').classList.add('hidden');
    document.getElementById('salas-empty').classList.remove('hidden');
  }

  function showSkeletons(n) {
    const cont = document.getElementById('salas-skeleton');
    cont.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const sk = document.createElement('div');
      sk.className = 'card sala-skeleton';
      cont.appendChild(sk);
    }
  }

  function handleBack() {
    if (current.sala) {
      current.sala = null;
      renderSalaInfo(null);
    } else if (current.centro) {
      current.centro = null;
      renderCentros();
    } else if (current.ciudad) {
      current.ciudad = null;
      renderCities();
    }
  }

  function renderCities() {
    const cont = document.getElementById('salas-cities');
    cont.innerHTML = '';
    const ciudades = [...new Set(
      salasOriginales.map(r => String(r.Ciudad || '').trim()).filter(v => v)
    )].sort();
    ciudades.forEach(ciudad => {
      const centersMap = {};
      salasOriginales
        .filter(r => String(r.Ciudad || '').trim() === ciudad)
        .forEach(r => {
          const centro = String(r.Centro || '').trim();
          if (!centro) return;
          if (!centersMap[centro]) {
          const info = centrosInfo[centro] || {};
          centersMap[centro] = {
            count: 0,
            direccion: info.DireccionCentro || info['Direccion Centro'] || ''
          };
        }
        centersMap[centro].count++;
      });
      const centros = Object.keys(centersMap).sort().map(k => ({
        nombre: k,
        count: centersMap[k].count,
        direccion: centersMap[k].direccion
      }));
      cont.appendChild(crearCiudadCard(ciudad, centros));
    });
    toggleViews('cities');
  }

  function crearCiudadCard(ciudad, centros) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    const h3 = document.createElement('h3');
    h3.textContent = ciudad;
    card.appendChild(h3);
    const ul = document.createElement('ul');
    ul.className = 'sala-centros';
    ul.style.listStyle = 'none';
    ul.style.padding = '0';
    centros.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${c.nombre}</strong> (${c.count} sala${c.count === 1 ? '' : 's'})`;
      if (c.direccion) {
        const addr = document.createElement('div');
        addr.className = 'sala-centro-dir';
        addr.textContent = c.direccion;
        li.appendChild(addr);
      }
      ul.appendChild(li);
    });
    card.appendChild(ul);
    card.addEventListener('click', () => {
      current.ciudad = ciudad;
      renderCentros();
    });
    return card;
  }

  function renderCentros() {
    const cont = document.getElementById('salas-centers-list');
    cont.innerHTML = '';

    const grouped = {};
    const roomsByCenter = {};

    salasOriginales
      .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
      .forEach(r => {
        const nombre = String(r.Centro || '').trim();
        if (!nombre) return;
        grouped[nombre] = (grouped[nombre] || 0) + 1;
        if (userRole !== 'admin' && String(r.Activo) !== '1') return;
        if (!roomsByCenter[nombre]) roomsByCenter[nombre] = [];
        roomsByCenter[nombre].push(r);
      });

    Object.keys(grouped)
      .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }))
      .forEach(nombre => {
        const info = centrosInfo[nombre] || {};
        const salas = (roomsByCenter[nombre] || [])
          .map(r => {
            const salaNombre = String(r.Nombre || r['Nombre Sala'] || '').trim();
            return {
              nombre: salaNombre || 'Sala sin nombre',
              capacidad: String(r.Capacidad || r['Capacidad'] || '').trim()
            };
          })
          .sort((a, b) => a.nombre.localeCompare(b.nombre, undefined, { numeric: true, sensitivity: 'base' }));

        cont.appendChild(
          crearCentroCard({
            nombre,
            count: salas.length,
            direccion: info['Direccion Centro'] || info.DireccionCentro || info.Direccion || '',
            telefono: info.Telefono || info['Teléfono'] || '',
            email: info.Email || '',
            responsable: info.Responsable || info['Responsable Centro'] || '',
            salas
          })
        );
      });

    renderCiudadImagen();
    toggleViews('centers');
  }

  function renderCiudadImagen() {
    const img = document.getElementById('salas-city-image');
    const placeholder = document.getElementById('salas-city-image-empty');
    const ciudad = obtenerCiudadInfo(current.ciudad) || {};
    const url =
      ciudad['Imagen Ciudad'] ||
      ciudad['Imagen ciudad'] ||
      ciudad.ImagenCiudad ||
      ciudad.imagenCiudad ||
      ciudad.Imagen ||
      ciudad.Plano || '';
    if (url) {
      img.src = url;
      img.alt = `Mapa de centros de ${current.ciudad}`;
      img.classList.remove('hidden');
      placeholder.classList.add('hidden');
    } else {
      img.alt = 'Mapa de centros no disponible';
      img.classList.add('hidden');
      placeholder.classList.remove('hidden');
    }
  }

  function renderSalas() {
    const cont = document.getElementById('salas-rooms');
    cont.innerHTML = '';
    currentRooms = salasOriginales
      .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
      .filter(r => String(r.Centro || '').trim() === current.centro)
      .filter(r => String(r.Activo) === '1' || userRole === 'admin');

    currentRooms.forEach(s => cont.appendChild(crearSalaCard(s)));
    renderSalaInfo(null);
    toggleViews('rooms');
  }

  function renderSalaInfo(s) {
    const img = document.getElementById('salas-plan');
    const info = document.getElementById('salas-info-text');
    document.querySelectorAll('#salas-rooms .sala-card').forEach(card => {
      card.classList.toggle('selected', s && card.dataset.name === s.Nombre);
    });
    if (s) {
      current.sala = s.Nombre;
      if (s.MapaSala || s['Mapa Sala']) {
        img.src = s.MapaSala || s['Mapa Sala'];
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      info.textContent = s.Observaciones || '';
    } else {
      current.sala = null;
      const base = currentRooms[0] || {};
      const plano = base.UbicacionCentro || base.PlanoCentro || base['Ubicacion Centro'] || '';
      if (plano) {
        img.src = plano;
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      info.textContent = base.InformacionCentro || base.InfoCentro || base['Informacion Centro'] || '';
    }
  }

  function crearSimpleCard(text, onClick) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    const h3 = document.createElement('h3');
    h3.textContent = text;
    card.appendChild(h3);
    card.addEventListener('click', onClick);
    return card;
  }

  function crearCentroCard(datos) {
    const card = document.createElement('div');
    card.className = 'card sala-card sala-center-card';

    const head = document.createElement('div');
    head.className = 'card-head sala-center-head';
    const title = document.createElement('h3');
    title.textContent = datos.nombre || '—';
    head.appendChild(title);

    if (datos.count != null) {
      const badge = document.createElement('span');
      badge.className = 'sala-badge sala-center-badge';
      badge.textContent = `${datos.count} sala${datos.count === 1 ? '' : 's'}`;
      head.appendChild(badge);
    }

    card.appendChild(head);

    const body = document.createElement('div');
    body.className = 'sala-center-body';

    const infoSection = document.createElement('div');
    infoSection.className = 'sala-center-info';

    [
      { icon: CENTER_ICONS.ubicacion, texto: datos.direccion },
      { icon: CENTER_ICONS.telefono, texto: datos.telefono },
      { icon: CENTER_ICONS.email, texto: datos.email },
      { icon: CENTER_ICONS.responsable, texto: datos.responsable }
    ].forEach(item => {
      if (!item.texto) return;
      const row = document.createElement('div');
      row.className = 'sala-center-row';

      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'sala-center-icon';
      const iconImg = document.createElement('img');
      iconImg.className = 'sala-center-icon-img';
      iconImg.src = item.icon.src;
      iconImg.alt = item.icon.alt;
      iconImg.loading = 'lazy';
      iconWrapper.appendChild(iconImg);

      const text = document.createElement('span');
      text.className = 'sala-center-text';
      text.textContent = item.texto;

      row.appendChild(iconWrapper);
      row.appendChild(text);
      infoSection.appendChild(row);
    });

    if (infoSection.children.length) {
      body.appendChild(infoSection);
    }

    if (Array.isArray(datos.salas) && datos.salas.length) {
      const roomsSection = document.createElement('div');
      roomsSection.className = 'sala-center-rooms-section';

      const roomsTitle = document.createElement('div');
      roomsTitle.className = 'sala-center-section-title';
      roomsTitle.textContent = 'Salas de formación';
      roomsSection.appendChild(roomsTitle);

      const roomsList = document.createElement('ul');
      roomsList.className = 'sala-center-rooms';

      datos.salas.forEach(sala => {
        const item = document.createElement('li');
        item.className = 'sala-center-room';

        const name = document.createElement('span');
        name.className = 'sala-center-room-name';
        name.textContent = sala.capacidad ? `${sala.nombre || '—'}:` : sala.nombre || '—';
        item.appendChild(name);

        if (sala.capacidad) {
          const capacity = document.createElement('span');
          capacity.className = 'sala-center-room-capacity';
          capacity.textContent = `Capacidad ${sala.capacidad}`;
          item.appendChild(capacity);
        }

        roomsList.appendChild(item);
      });

      roomsSection.appendChild(roomsList);
      body.appendChild(roomsSection);
    }

    if (body.children.length) card.appendChild(body);

    card.addEventListener('click', () => {
      current.centro = datos.nombre;
      renderSalas();
    });

    return card;
  }

  function crearSalaCard(s) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    card.dataset.name = s.Nombre;

    const head = document.createElement('div');
    head.className = 'card-head';
    const h3 = document.createElement('h3');
    h3.textContent = s.Nombre || '—';
    head.appendChild(h3);
    const badges = document.createElement('div');
    badges.className = 'sala-badges';
    const cap = document.createElement('span');
    cap.className = 'sala-badge';
    cap.textContent = 'Capacidad ' + (s.Capacidad || '—');
    badges.appendChild(cap);
    if (s.Equipamiento) {
      const eq = document.createElement('span');
      eq.className = 'sala-badge';
      eq.textContent = s.Equipamiento;
      badges.appendChild(eq);
    }
    head.appendChild(badges);
    card.appendChild(head);

    card.addEventListener('click', () => renderSalaInfo(s));
    return card;
  }

  function toggleViews(view) {
    document.getElementById('salas-skeleton').classList.add('hidden');
    document.getElementById('salas-back').classList.toggle('hidden', view === 'cities');
    document.getElementById('salas-empty').classList.add('hidden');
    document.getElementById('salas-cities').classList.toggle('hidden', view !== 'cities');
    document.getElementById('salas-centers').classList.toggle('hidden', view !== 'centers');
    document.getElementById('salas-layout').classList.toggle('hidden', view !== 'rooms');
    if (view !== 'rooms') current.sala = null;
    if (view !== 'centers') current.centro = view === 'rooms' ? current.centro : null;
  }
</script>
