<!-- salas.html -->
<style>
  /* Mantiene la separación entre la lista de salas y el panel derecho */
  #salas-layout .sala-info-panel {
    margin-left: clamp(1.75rem, 4vw, 3rem);
  }

  /* Separa visualmente las dos columnas de tarjetas de salas */
  #salas-rooms {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    column-gap: clamp(3.5rem, 3vw, 2.75rem);
    row-gap: clamp(1rem, 2.5vw, 2rem);
  }

  @media (max-width: 960px) {
    #salas-layout .sala-info-panel {
      margin-left: 0;
    }

    #salas-rooms {
      grid-template-columns: 1fr;
      column-gap: 0;
      row-gap: clamp(1rem, 4vw, 1.75rem);
    }
  }

  #salas-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.65);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    z-index: 120;
  }

  #salas-spinner .spinner-text {
    color: var(--negro, #111);
    font-weight: 600;
    letter-spacing: 0.05em;
  }
</style>

<button id="salas-back" class="hidden btn-back">← Volver</button>

<div id="salas-skeleton" class="salas-grid"></div>

<div id="salas-cities" class="salas-grid hidden" aria-live="polite"></div>
<div id="salas-centers" class="salas-centers-layout hidden" aria-live="polite">
  <div id="salas-centers-list" class="salas-centers-list"></div>
  <div class="salas-centers-divider" role="presentation" aria-hidden="true"></div>
  <div id="salas-city-visual" class="salas-city-visual">
    <img id="salas-city-image" class="salas-city-image hidden" alt="Mapa de centros de la ciudad" />
    <div id="salas-city-image-empty" class="salas-city-image-empty">No hay imagen disponible para esta ciudad.</div>
  </div>
</div>

<div id="salas-layout" class="salas-layout hidden">
  <div id="salas-rooms" class="salas-grid salas-rooms"></div>
  <div id="salas-info" class="sala-info-panel">
    <img id="salas-plan" class="sala-plan hidden" alt="Plano" />
    <div id="salas-info-text" class="sala-info-text"></div>
  </div>
</div>

<div id="salas-empty" class="salas-empty hidden">No hay datos.</div>

<div id="salas-spinner" class="hidden" role="status" aria-live="assertive">
  <div class="spinner" aria-hidden="true"></div>
  <div class="spinner-text">Cargando…</div>
</div>

<script>
  const userRole = (window.USER_ROLE || '').toLowerCase();
  let salasOriginales = [];
  let centrosInfo = Object.create(null);
  let ciudadesInfo = Object.create(null);
  let current = { ciudad: null, centro: null, sala: null };
  let currentRooms = [];

  const salasSpinner = document.getElementById('salas-spinner');
  function showSalasSpinner() {
    if (salasSpinner) salasSpinner.classList.remove('hidden');
  }

  function hideSalasSpinner() {
    if (!salasSpinner) return;
    requestAnimationFrame(() => salasSpinner.classList.add('hidden'));
  }

  const CENTER_ICONS = {
    ubicacion: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=12T2BaLFqegpXg0oJmEixxe3t9HJdHDaM',
      alt: 'Dirección del centro'
    },
    telefono: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1XZ5SQVTZGMqd2vv8P8OzAPhZsRwG_9Rh',
      alt: 'Teléfono del centro'
    },
    email: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=17P7Zvt0mc-Zl-5FVEfpwFw0Q9EU6_QET',
      alt: 'Correo electrónico del centro'
    },
    responsable: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1pIojlguVE1hxt3ftk1YqIRUwYxLzOvsP',
      alt: 'Responsable del centro'
    }
  };

  const ROOM_ICONS = {
    centro: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1ZYyCPVHnfgUPasiAl2fGhDd1GNSou0mn',
      alt: 'Centro de la sala'
    },
    capacidad: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1wX-Xmw1kwh5f3j25LFaN55WPYK9TTPAI',
      alt: 'Capacidad de la sala'
    },
    equipamiento: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1-KFgTTT3Wri6uvFc7gXWmGj273KKi-uq',
      alt: 'Equipamiento disponible en la sala'
    },
    software: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=1g1PfNfqGh9oY7vq9GzNS8QfWayANxhMY',
      alt: 'Software disponible en la sala'
    },
    horario: {
      src: 'https://drive.google.com/thumbnail?sz=w1000&id=10oZbj36hTAS6CaCAIi0lrv-86iD416Xc',
      alt: 'Horario de la sala'
    }
  };

  function normalizarClaveCiudad(valor) {
    if (!valor) return '';
    let texto = String(valor).trim().toLowerCase();
    if (typeof String.prototype.normalize === 'function') {
      try {
        return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (error) {
        // Si falla seguimos con la aproximación manual de abajo.
      }
    }
    return texto
      .replace(/[áàäâãå]/g, 'a')
      .replace(/[éèëê]/g, 'e')
      .replace(/[íìïî]/g, 'i')
      .replace(/[óòöôõ]/g, 'o')
      .replace(/[úùüû]/g, 'u')
      .replace(/ñ/g, 'n')
      .replace(/ç/g, 'c');
  }

  function guardarCiudadInfo(nombre, datos) {
    if (!nombre) return;
    ciudadesInfo[nombre] = datos;
    const clave = normalizarClaveCiudad(nombre);
    if (clave && clave !== nombre) {
      ciudadesInfo[clave] = datos;
    }
  }

  function obtenerCiudadInfo(nombre) {
    if (!nombre) return null;
    return ciudadesInfo[nombre] || ciudadesInfo[normalizarClaveCiudad(nombre)] || null;
  }

  function guardarCentroInfo(nombre, datos) {
    if (!nombre) return;
    centrosInfo[nombre] = datos;
    const clave = normalizarClaveCiudad(nombre);
    if (clave && clave !== nombre) {
      centrosInfo[clave] = datos;
    }
  }

  function obtenerCentroInfo(nombre) {
    if (!nombre) return null;
    return centrosInfo[nombre] || centrosInfo[normalizarClaveCiudad(nombre)] || null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    showSalasSpinner();
    showSkeletons(4);
    cargarCiudades();
    document.getElementById('salas-back').addEventListener('click', handleBack);
  });

  function cargarCiudades() {
    showSalasSpinner();
    google.script.run
      .withSuccessHandler(ciudades => {
        ciudadesInfo = Object.create(null);
        (Array.isArray(ciudades) ? ciudades : []).forEach(c => {
          const nombre = String(
            c['Ciudad'] ||
            c['Nombre Ciudad'] ||
            c.NombreCiudad ||
            c.Nombre ||
            ''
          ).trim();
          if (nombre) guardarCiudadInfo(nombre, c);
        });
        cargarCentros();
      })
      .withFailureHandler(handleLoadError)
      .getAllCiudades();
  }

  function cargarCentros() {
    showSalasSpinner();
    google.script.run
      .withSuccessHandler(centros => {
        centrosInfo = Object.create(null);
        (Array.isArray(centros) ? centros : []).forEach(c => {
          const nombre = String(c['Nombre Centro'] || c.NombreCentro || c.Nombre || '').trim();
          if (nombre) guardarCentroInfo(nombre, c);
        });
        cargarSalas();
      })
      .withFailureHandler(handleLoadError)
      .getAllCentros();
  }

  function cargarSalas() {
    showSalasSpinner();
    google.script.run
      .withSuccessHandler(salas => {
        salasOriginales = Array.isArray(salas) ? salas : [];
        renderCities();
      })
      .withFailureHandler(handleLoadError)
      .getAllSalas();
  }

  function handleLoadError(err) {
    console.error(err);
    document.getElementById('salas-skeleton').classList.add('hidden');
    document.getElementById('salas-empty').classList.remove('hidden');
    hideSalasSpinner();
  }

  function showSkeletons(n) {
    const cont = document.getElementById('salas-skeleton');
    cont.innerHTML = '';
    for (let i = 0; i < n; i++) {
      const sk = document.createElement('div');
      sk.className = 'card sala-skeleton';
      cont.appendChild(sk);
    }
  }

  function handleBack() {
    if (current.sala) {
      current.sala = null;
      renderSalaInfo(null);
    } else if (current.centro) {
      current.centro = null;
      renderCentros();
    } else if (current.ciudad) {
      current.ciudad = null;
      renderCities();
    }
  }

  function renderCities() {
    showSalasSpinner();
    const cont = document.getElementById('salas-cities');
    cont.innerHTML = '';
    const ciudades = [...new Set(
      salasOriginales.map(r => String(r.Ciudad || '').trim()).filter(v => v)
    )].sort();
    ciudades.forEach(ciudad => {
      const centersMap = {};
      salasOriginales
        .filter(r => String(r.Ciudad || '').trim() === ciudad)
        .forEach(r => {
          const centro = String(r.Centro || '').trim();
          if (!centro) return;
          if (!centersMap[centro]) {
            const info = obtenerCentroInfo(centro) || {};
            centersMap[centro] = {
              count: 0,
              direccion:
                info.DireccionCentro ||
                info['Direccion Centro'] ||
                info['Dirección Centro'] ||
                ''
            };
          }
        centersMap[centro].count++;
      });
      const centros = Object.keys(centersMap).sort().map(k => ({
        nombre: k,
        count: centersMap[k].count,
        direccion: centersMap[k].direccion
      }));
      cont.appendChild(crearCiudadCard(ciudad, centros));
    });
    toggleViews('cities');
    hideSalasSpinner();
  }

  function crearCiudadCard(ciudad, centros) {
    const card = document.createElement('div');
    card.className = 'card sala-card sala-city-card';

    const head = document.createElement('div');
    head.className = 'card-head sala-city-head';
    const title = document.createElement('h3');
    title.className = 'sala-city-title';
    title.textContent = ciudad || '—';
    head.appendChild(title);
    card.appendChild(head);

    const centersList = document.createElement('div');
    centersList.className = 'sala-city-centers';

    centros.forEach(c => {
      const item = document.createElement('div');
      item.className = 'sala-city-center';

      const centerHead = document.createElement('div');
      centerHead.className = 'sala-city-center-head';

      const name = document.createElement('span');
      name.className = 'sala-city-center-name';
      name.textContent = c.nombre || '—';
      centerHead.appendChild(name);

      if (c.count != null) {
        const count = document.createElement('span');
        count.className = 'sala-city-center-count';
        count.textContent = `${c.count} sala${c.count === 1 ? '' : 's'}`;
        centerHead.appendChild(count);
      }

      item.appendChild(centerHead);

      if (c.direccion) {
        const addressRow = document.createElement('div');
        addressRow.className = 'sala-city-center-address';

        const iconWrapper = document.createElement('span');
        iconWrapper.className = 'sala-city-icon';
        const iconImg = document.createElement('img');
        iconImg.className = 'sala-city-icon-img';
        iconImg.src = CENTER_ICONS.ubicacion.src;
        iconImg.alt = CENTER_ICONS.ubicacion.alt;
        iconImg.loading = 'lazy';
        iconWrapper.appendChild(iconImg);

        const text = document.createElement('span');
        text.className = 'sala-city-address-text';
        text.textContent = c.direccion;

        addressRow.appendChild(iconWrapper);
        addressRow.appendChild(text);
        item.appendChild(addressRow);
      }

      centersList.appendChild(item);
    });

    card.appendChild(centersList);
    card.addEventListener('click', () => {
      current.ciudad = ciudad;
      renderCentros();
    });
    return card;
  }

  function renderCentros() {
    showSalasSpinner();
    const cont = document.getElementById('salas-centers-list');
    cont.innerHTML = '';

    const grouped = {};
    const roomsByCenter = {};

    salasOriginales
      .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
      .forEach(r => {
        const nombre = String(r.Centro || '').trim();
        if (!nombre) return;
        grouped[nombre] = (grouped[nombre] || 0) + 1;
        if (userRole !== 'admin' && String(r.Activo) !== '1') return;
        if (!roomsByCenter[nombre]) roomsByCenter[nombre] = [];
        roomsByCenter[nombre].push(r);
      });

    Object.keys(grouped)
      .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }))
      .forEach(nombre => {
        const info = obtenerCentroInfo(nombre) || {};
        const salas = (roomsByCenter[nombre] || [])
          .map(r => {
            const salaNombre = String(r.Nombre || r['Nombre Sala'] || '').trim();
            return {
              nombre: salaNombre || 'Sala sin nombre',
              capacidad: String(r.Capacidad || r['Capacidad'] || '').trim()
            };
          })
          .sort((a, b) => a.nombre.localeCompare(b.nombre, undefined, { numeric: true, sensitivity: 'base' }));

        cont.appendChild(
          crearCentroCard({
            nombre,
            count: salas.length,
            direccion:
              info['Direccion Centro'] ||
              info['Dirección Centro'] ||
              info.DireccionCentro ||
              info.Direccion ||
              '',
            telefono: info.Telefono || info['Teléfono'] || '',
            email: info.Email || '',
            responsable: info.Responsable || info['Responsable Centro'] || '',
            salas
          })
        );
      });

    renderCiudadImagen();
    toggleViews('centers');
    hideSalasSpinner();
  }

  function renderCiudadImagen() {
    const img = document.getElementById('salas-city-image');
    const placeholder = document.getElementById('salas-city-image-empty');
    const ciudad = obtenerCiudadInfo(current.ciudad) || {};
    const url =
      ciudad['Imagen Ciudad'] ||
      ciudad['Imagen ciudad'] ||
      ciudad.ImagenCiudad ||
      ciudad.imagenCiudad ||
      ciudad.Imagen ||
      ciudad.Plano || '';
    if (url) {
      img.src = url;
      img.alt = `Mapa de centros de ${current.ciudad}`;
      img.classList.remove('hidden');
      placeholder.classList.add('hidden');
    } else {
      img.alt = 'Mapa de centros no disponible';
      img.classList.add('hidden');
      placeholder.classList.remove('hidden');
    }
  }

  function renderSalas() {
    showSalasSpinner();
    const cont = document.getElementById('salas-rooms');
    cont.innerHTML = '';
    currentRooms = salasOriginales
      .filter(r => String(r.Ciudad || '').trim() === current.ciudad)
      .filter(r => String(r.Centro || '').trim() === current.centro)
      .filter(r => String(r.Activo) === '1' || userRole === 'admin');

    currentRooms.forEach(s => cont.appendChild(crearSalaCard(s)));
    renderSalaInfo(null);
    toggleViews('rooms');
    hideSalasSpinner();
  }

  function renderSalaInfo(s) {
    const img = document.getElementById('salas-plan');
    const info = document.getElementById('salas-info-text');
    document.querySelectorAll('#salas-rooms .sala-card').forEach(card => {
      const targetName = s ? String(s.Nombre || s['Nombre Sala'] || '') : '';
      card.classList.toggle('selected', Boolean(s) && card.dataset.name === targetName);
    });
    if (s) {
      current.sala = String(s.Nombre || s['Nombre Sala'] || '');
      const salaImage =
        s['Imagen Sala'] ||
        s.ImagenSala ||
        s.MapaSala ||
        s['Mapa Sala'] ||
        '';
      if (salaImage) {
        img.src = salaImage;
        img.alt = `Plano de la sala ${current.sala}`;
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      info.textContent = s.Observaciones || '';
    } else {
      current.sala = null;
      const base = currentRooms[0] || {};
      const centroInfo = obtenerCentroInfo(current.centro) || {};
      const plano =
        centroInfo['Imagen Centro'] ||
        centroInfo.ImagenCentro ||
        centroInfo.PlanoCentro ||
        centroInfo['Plano Centro'] ||
        base.UbicacionCentro ||
        base.PlanoCentro ||
        base['Ubicacion Centro'] ||
        '';
      if (plano) {
        img.src = plano;
        img.alt = `Plano del centro ${current.centro || ''}`.trim() || 'Plano del centro';
        img.classList.remove('hidden');
      } else {
        img.classList.add('hidden');
      }
      const infoCentro =
        centroInfo['Informacion Centro'] ||
        centroInfo.InformacionCentro ||
        centroInfo.InfoCentro ||
        base.InformacionCentro ||
        base.InfoCentro ||
        base['Informacion Centro'] ||
        '';
      info.textContent = infoCentro;
    }
  }

  function crearSimpleCard(text, onClick) {
    const card = document.createElement('div');
    card.className = 'card sala-card';
    const h3 = document.createElement('h3');
    h3.textContent = text;
    card.appendChild(h3);
    card.addEventListener('click', onClick);
    return card;
  }

  function crearCentroCard(datos) {
    const card = document.createElement('div');
    card.className = 'card sala-card sala-center-card';

    const head = document.createElement('div');
    head.className = 'card-head sala-center-head';
    const title = document.createElement('h3');
    title.textContent = datos.nombre || '—';
    head.appendChild(title);

    card.appendChild(head);

    const body = document.createElement('div');
    body.className = 'sala-center-body';

    const infoSection = document.createElement('div');
    infoSection.className = 'sala-center-info';

    [
      { icon: CENTER_ICONS.ubicacion, texto: datos.direccion },
      { icon: CENTER_ICONS.telefono, texto: datos.telefono },
      { icon: CENTER_ICONS.email, texto: datos.email },
      { icon: CENTER_ICONS.responsable, texto: datos.responsable }
    ].forEach(item => {
      if (!item.texto) return;
      const row = document.createElement('div');
      row.className = 'sala-center-row';

      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'sala-center-icon';
      const iconImg = document.createElement('img');
      iconImg.className = 'sala-center-icon-img';
      iconImg.src = item.icon.src;
      iconImg.alt = item.icon.alt;
      iconImg.loading = 'lazy';
      iconWrapper.appendChild(iconImg);

      const text = document.createElement('span');
      text.className = 'sala-center-text';
      text.textContent = item.texto;

      row.appendChild(iconWrapper);
      row.appendChild(text);
      infoSection.appendChild(row);
    });

    if (infoSection.children.length) {
      body.appendChild(infoSection);
    }

    if (Array.isArray(datos.salas) && datos.salas.length) {
      const roomsSection = document.createElement('div');
      roomsSection.className = 'sala-center-rooms-section';

      const roomsTitle = document.createElement('div');
      roomsTitle.className = 'sala-center-section-title';
      roomsTitle.textContent = 'Salas de formación';
      roomsSection.appendChild(roomsTitle);

      const roomsList = document.createElement('ul');
      roomsList.className = 'sala-center-rooms';

      datos.salas.forEach(sala => {
        const item = document.createElement('li');
        item.className = 'sala-center-room';

        const name = document.createElement('span');
        name.className = 'sala-center-room-name';
        name.textContent = sala.capacidad ? `${sala.nombre || '—'}:` : sala.nombre || '—';
        item.appendChild(name);

        if (sala.capacidad) {
          const capacity = document.createElement('span');
          capacity.className = 'sala-center-room-capacity';
          capacity.textContent = `Capacidad ${sala.capacidad}`;
          item.appendChild(capacity);
        }

        roomsList.appendChild(item);
      });

      roomsSection.appendChild(roomsList);
      body.appendChild(roomsSection);
    }

    if (body.children.length) card.appendChild(body);

    card.addEventListener('click', () => {
      current.centro = datos.nombre;
      renderSalas();
    });

    return card;
  }

  function crearSalaCard(s) {
    const rawNombre = String(s.Nombre || s['Nombre Sala'] || '');
    const nombre = rawNombre.trim() || 'Sala sin nombre';
    const centro = String(s.Centro || '').trim();
    const capacidad = String(s.Capacidad || s['Capacidad'] || '').trim();
    const equipamiento = String(s.Equipamiento || s['Equipamiento'] || '').trim();
    const software = String(s.Software || s['Software'] || '').trim();
    const horario = String(s.Horario || s['Horario'] || '').trim();

    const card = document.createElement('div');
    card.className = 'card sala-card sala-center-card sala-room-card';
    card.dataset.name = rawNombre;

    const head = document.createElement('div');
    head.className = 'card-head sala-center-head sala-room-head';
    const h3 = document.createElement('h3');
    h3.className = 'sala-room-title';
    h3.textContent = nombre;
    head.appendChild(h3);
    card.appendChild(head);

    const body = document.createElement('div');
    body.className = 'sala-center-body sala-room-body';

    const infoSection = document.createElement('div');
    infoSection.className = 'sala-center-info sala-room-info';

    [
      { icon: ROOM_ICONS.centro, texto: centro },
      { icon: ROOM_ICONS.capacidad, texto: capacidad },
      { icon: ROOM_ICONS.equipamiento, texto: equipamiento },
      { icon: ROOM_ICONS.software, texto: software },
      { icon: ROOM_ICONS.horario, texto: horario }
    ].forEach(item => {
      if (!item.texto) return;
      const row = document.createElement('div');
      row.className = 'sala-center-row sala-room-row';

      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'sala-center-icon sala-room-icon';
      const iconImg = document.createElement('img');
      iconImg.className = 'sala-center-icon-img sala-room-icon-img';
      iconImg.src = item.icon.src;
      iconImg.alt = item.icon.alt;
      iconImg.loading = 'lazy';
      iconWrapper.appendChild(iconImg);

      const text = document.createElement('span');
      text.className = 'sala-center-text sala-room-text';
      text.textContent = item.texto;

      row.appendChild(iconWrapper);
      row.appendChild(text);
      infoSection.appendChild(row);
    });

    if (infoSection.children.length) {
      body.appendChild(infoSection);
    }

    if (body.children.length) {
      card.appendChild(body);
    }

    card.addEventListener('click', () => renderSalaInfo(s));
    return card;
  }

  function toggleViews(view) {
    document.getElementById('salas-skeleton').classList.add('hidden');
    document.getElementById('salas-back').classList.toggle('hidden', view === 'cities');
    document.getElementById('salas-empty').classList.add('hidden');
    document.getElementById('salas-cities').classList.toggle('hidden', view !== 'cities');
    document.getElementById('salas-centers').classList.toggle('hidden', view !== 'centers');
    document.getElementById('salas-layout').classList.toggle('hidden', view !== 'rooms');
    if (view !== 'rooms') current.sala = null;
    if (view !== 'centers') current.centro = view === 'rooms' ? current.centro : null;
  }
</script>
