<!-- misreservas.html -->
<div class="reservas-container">
  <div class="reservas-header" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">

    <div class="filter-style">
      <div class="filter">
        <label for="filterCiudadMis">Ciudad:</label>
        <select id="filterCiudadMis">
          <option value="">— Elige Ciudad —</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterCentroMis">Centro:</label>
        <select id="filterCentroMis" disabled>
          <option value="">— Elige Centro —</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterSalaMis">Sala:</label>
        <select id="filterSalaMis" disabled>
          <option value="">— Elige Sala —</option>
        </select>
      </div>

      <div class="filter">
        <label for="filterFechaMis">Fecha:</label>
        <input id="filterFechaMis" type="text" placeholder="Selecciona fecha" />
      </div>

      <button type="button" id="mis-clear-filters" class="btn-filters-clear">Quitar filtros</button>
      <button type="button" id="mis-reservas-reload" class="btn-filters-clear" style="margin-left:.5rem;">Recargar datos</button>
    </div>

    <div class="filter-style" style="margin-bottom:0;">
      <div class="filter">
        <label for="searchIdMis">Buscar por ID Reserva:</label>
        <input id="searchIdMis" type="text" placeholder="Introduce ID Reserva…" />
      </div>
      <button type="button" id="mis-export-csv" class="btn-filters-clear">Exportar CSV</button>
    </div>
  </div>

  <div class="salas-table-container">
    <table id="misReservasTable" class="table-style" style="margin-top: 1rem;">
      <thead>
        <tr>
          <th data-sort="ID">ID Reserva</th>
          <th data-sort="Sala">Sala</th>
          <th data-sort="Capacidad">Capacidad</th>
          <th data-sort="Ciudad">Ciudad</th>
          <th data-sort="Centro">Centro</th>
          <th data-sort="Motivo">Motivo</th>
          <th data-sort="Personas">Personas</th>
          <th data-sort="Inicio">Inicio</th>
          <th data-sort="Fin">Fin</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal editar reserva -->
  <div id="editModal" class="modal-reserva-bg" style="display:none;">
    <div class="modal-reserva">
      <h2 class="modal-reserva-titulo">Editar Reserva</h2>
      <form id="formEditReserva" autocomplete="off">
        <input id="editMotivo" type="text" class="modal-reserva-input" placeholder="Motivo de la reserva" required />
        <input id="editMotivoMod" type="text" class="modal-reserva-input" placeholder="Motivo de la modificación" required />
        <div class="modal-reserva-fechas">
          <div>
            <label for="editFechaInicio" class="modal-reserva-label">Fecha inicio</label><br />
            <input id="editFechaInicio" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
          <div>
            <label for="editFechaFin" class="modal-reserva-label">Fecha fin</label><br />
            <input id="editFechaFin" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
        </div>
        <div class="modal-reserva-fechas">
          <div>
            <label for="editHoraInicio" class="modal-reserva-label">Hora inicio</label><br />
            <input id="editHoraInicio" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
          <div>
            <label for="editHoraFin" class="modal-reserva-label">Hora fin</label><br />
            <input id="editHoraFin" type="text" class="modal-reserva-datetime" autocomplete="off" required />
          </div>
        </div>
        <div class="modal-reserva-botones">
          <button type="button" id="btnEditCancelar" class="modal-reserva-btn-cancelar">Cancelar</button>
          <button type="submit" id="btnEditGuardar" class="modal-reserva-btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal eliminar reserva -->
  <div id="misDeleteOverlay" class="modal-overlay" style="display:none;">
    <div class="modal flex-col">
      <div class="modal-header mb-2">Eliminar Reserva</div>
      <div class="modal-body flex flex-col gap-3">
        <p id="misDeleteMsg" class="text-[#0d151b]"></p>
      </div>
      <div class="modal-footer" style="display:flex;gap:1rem;">
        <button id="misBtnDeleteCancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
        <button id="misBtnDeleteOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal información genérico -->
  <div id="infoOverlay" class="modal-overlay" style="display:none;">
    <div class="modal flex-col">
      <div id="infoHeader" class="modal-header mb-2">Información</div>
      <div class="modal-body flex flex-col gap-3">
        <p id="infoMsg" class="text-[#0d151b]"></p>
      </div>
      <div class="modal-footer">
        <button id="btnInfoOk" class="px-4 py-2 rounded bg-[#bc348b] text-white hover:bg-[#a1226d]">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- Flatpickr para fecha/rango -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
  // ---- CSV Export helper ----
  function downloadText(text, filename, type) {
    const blob = new Blob([text], {type});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(link.href); }, 150);
  }

  // ---- Flatpickr para filtros y edición ----
  window.fp_filterFechaMis = null;
  window.fp_editFechaInicio = null;
  window.fp_editFechaFin = null;
  window.fp_editHoraInicio = null;
  window.fp_editHoraFin = null;
  document.addEventListener('DOMContentLoaded', function() {
    window.fp_filterFechaMis = flatpickr('#filterFechaMis', {
      enableTime: false,
      dateFormat: 'Y-m-d',
      locale: 'es',
      onChange: () => App.applyFiltersAndRender()
    });
    window.fp_editFechaInicio = flatpickr('#editFechaInicio', {
      enableTime: false,
      dateFormat: 'Y-m-d',
      locale: 'es'
    });
    window.fp_editFechaFin = flatpickr('#editFechaFin', {
      enableTime: false,
      dateFormat: 'Y-m-d',
      locale: 'es'
    });
    window.fp_editHoraInicio = flatpickr('#editHoraInicio', {
      enableTime: true,
      noCalendar: true,
      time_24hr: true,
      dateFormat: 'H:i',
      locale: 'es',
      minuteIncrement: 5
    });
    window.fp_editHoraFin = flatpickr('#editHoraFin', {
      enableTime: true,
      noCalendar: true,
      time_24hr: true,
      dateFormat: 'H:i',
      locale: 'es',
      minuteIncrement: 5
    });
  });

  const App = {
    state: {
      misReservas: [],
      currentEditId: null,
      deleteId: null,
      sortBy: 'Inicio',
      sortDir: 'asc',
      deepLinkFilters: null,
      deepLinkApplied: false
    },

    /* ===================== DATA ===================== */
    loadMisReservas() {
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(reservas => {
          if (typeof hideSpinner === 'function') hideSpinner();
          this.state.misReservas = Array.isArray(reservas) ? reservas : [];
          this.poblarCiudades();
          this.applyDeepLinkFiltersIfNeeded();
          this.applyFiltersAndRender();
        })
        .withFailureHandler(err => {
          if (typeof hideSpinner === 'function') hideSpinner();
          console.error(err);
          this.showInfoModal('Error cargando tus reservas.', 'Error');
        })
        .getMisReservas();
    },

    captureDeepLinkFilters() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        const reservaId = (params.get('reservaId') || params.get('edit') || params.get('reserva') || '').trim();
        const ciudad = (params.get('ciudad') || '').trim();
        const centro = (params.get('centro') || '').trim();
        const sala   = (params.get('sala')   || '').trim();
        const fechaParam = (params.get('fecha') || params.get('fechaInicio') || params.get('inicio') || '').trim();
        const fecha = fechaParam ? fechaParam.split('T')[0] : '';
        if (reservaId || ciudad || centro || sala || fecha) {
          this.state.deepLinkFilters = { reservaId, ciudad, centro, sala, fecha };
        }
      } catch (err) {
        console.warn('No se pudieron leer los filtros desde la URL', err);
      }
    },

    selectHasOption(selectEl, value) {
      if (!selectEl || !value) return false;
      const target = value.trim();
      return Array.from(selectEl.options || []).some(opt => (opt.value || '').trim() === target);
    },

    applyDeepLinkFiltersIfNeeded() {
      if (this.state.deepLinkApplied || !this.state.deepLinkFilters) return;
      const { reservaId, ciudad, centro, sala, fecha } = this.state.deepLinkFilters;

      const selCiudad = document.getElementById('filterCiudadMis');
      if (ciudad && this.selectHasOption(selCiudad, ciudad)) {
        selCiudad.value = ciudad;
      }
      this.poblarCentros();

      const selCentro = document.getElementById('filterCentroMis');
      if (centro && this.selectHasOption(selCentro, centro)) {
        selCentro.value = centro;
      }
      this.poblarSalas();

      const selSala = document.getElementById('filterSalaMis');
      if (sala && this.selectHasOption(selSala, sala)) {
        selSala.value = sala;
      }

      if (fecha) {
        const fechaInput = document.getElementById('filterFechaMis');
        fechaInput.value = fecha;
        if (window.fp_filterFechaMis) {
          window.fp_filterFechaMis.setDate(fecha, false, 'Y-m-d');
        }
      }

      if (reservaId) {
        document.getElementById('searchIdMis').value = reservaId;
      }

      this.state.deepLinkApplied = true;
    },

    getFilters() {
      const term = document.getElementById('searchIdMis').value.toLowerCase().trim();
      const ciudad = document.getElementById('filterCiudadMis').value;
      const centro = document.getElementById('filterCentroMis').value;
      const sala = document.getElementById('filterSalaMis').value;
      const fecha = document.getElementById('filterFechaMis').value;
      return { term, ciudad, centro, sala, fecha };
    },

    applyFiltersAndRender() {
      const { term, ciudad, centro, sala, fecha } = this.getFilters();
      let data = this.state.misReservas;

      if (ciudad) {
        data = data.filter(r => (r.Ciudad?.trim() || '') === ciudad);
      }
      if (centro) {
        data = data.filter(r => (r.Centro?.trim() || '') === centro);
      }
      if (sala) {
        data = data.filter(r => (r.Sala?.trim() || '') === sala);
      }
      if (fecha) {
        data = data.filter(r => this.splitDateTime(r.Inicio).date === fecha);
      }
      if (term) {
        data = data.filter(r => String(r.ID || '').toLowerCase().includes(term));
      }

      // Ordenación
      data = [...data].sort((a,b) => this.sortCompare(a,b));
      this.updateSortIndicators();

      // Render
      this.renderTable(data, '#misReservasTable tbody', 'No tienes reservas');
    },

    poblarCiudades() {
      const selCiudad = document.getElementById('filterCiudadMis');
      const selCentro = document.getElementById('filterCentroMis');
      const selSala = document.getElementById('filterSalaMis');

      selCiudad.innerHTML = '<option value="">— Elige Ciudad —</option>';
      [...new Set(this.state.misReservas.map(r => r.Ciudad?.trim()).filter(Boolean))]
        .sort()
        .forEach(c => selCiudad.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
      selCiudad.disabled = false;

      selCentro.innerHTML = '<option value="">— Elige Centro —</option>';
      selSala.innerHTML = '<option value="">— Elige Sala —</option>';
    },

    poblarCentros() {
      const ciudad = document.getElementById('filterCiudadMis').value;
      const sel = document.getElementById('filterCentroMis');
      sel.innerHTML = '<option value="">— Elige Centro —</option>';
      let datos = this.state.misReservas;
      if (ciudad) datos = datos.filter(r => (r.Ciudad?.trim() || '') === ciudad);
      [...new Set(datos.map(r => r.Centro?.trim()).filter(Boolean))]
        .sort()
        .forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`));
      sel.disabled = false;
    },

    poblarSalas() {
      const ciudad = document.getElementById('filterCiudadMis').value;
      const centro = document.getElementById('filterCentroMis').value;
      const sel = document.getElementById('filterSalaMis');
      sel.innerHTML = '<option value="">— Elige Sala —</option>';
      let datos = this.state.misReservas;
      if (ciudad) datos = datos.filter(r => (r.Ciudad?.trim() || '') === ciudad);
      if (centro) datos = datos.filter(r => (r.Centro?.trim() || '') === centro);
      [...new Set(datos.map(r => r.Sala?.trim()).filter(Boolean))]
        .sort()
        .forEach(s => sel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));
      sel.disabled = false;
    },

    limpiarFiltros() {
      document.getElementById('filterCiudadMis').value = '';
      this.poblarCentros();
      document.getElementById('filterCentroMis').value = '';
      this.poblarSalas();
      document.getElementById('filterSalaMis').value = '';
      document.getElementById('filterFechaMis').value = '';
      if (window.fp_filterFechaMis) window.fp_filterFechaMis.clear();
      document.getElementById('searchIdMis').value = '';
      this.applyFiltersAndRender();
    },

    /* ================= ORDENACIÓN ================= */
    setupSorting() {
      const ths = document.querySelectorAll('#misReservasTable thead th[data-sort]');
      ths.forEach(th => {
        th.dataset.label = th.textContent.trim();
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (this.state.sortBy === key) {
            this.state.sortDir = this.state.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.state.sortBy = key;
            this.state.sortDir = 'asc';
          }
          this.applyFiltersAndRender();
        });
      });
      this.updateSortIndicators();
    },

    updateSortIndicators() {
      const ths = document.querySelectorAll('#misReservasTable thead th[data-sort]');
      ths.forEach(th => {
        th.classList.remove('sort-asc','sort-desc');
        if (th.dataset.sort === this.state.sortBy) {
          th.classList.add(this.state.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    },

    parseFechaDMY(str) {
      // '05/07/2025 14:00' -> Date
      if (!str) return null;
      const [fecha, hora] = String(str).split(' ');
      if (!fecha || !hora) return null;
      const [d,m,y] = fecha.split('/').map(x => x.padStart(2,'0'));
      const iso = `${y}-${m}-${d}T${hora}`;
      const dte = new Date(iso);
      return isNaN(dte) ? null : dte;
    },

    splitDateTime(str) {
      const [fecha, hora] = String(str ?? '').split(' ');
      const time = (hora ?? '').trim();
      if (!fecha || !time) return { date: '', time: '' };
      const [d, m, y] = fecha.split('/').map(part => part?.trim?.() || '');
      if (!d || !m || !y) return { date: '', time: '' };
      return {
        date: `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
        time
      };
    },

    _sortValue(row, key) {
      switch (key) {
        case 'Inicio': return this.parseFechaDMY(row.Inicio);
        case 'Fin':    return this.parseFechaDMY(row.Fin);
        default:       return (row[key] ?? '').toString().toLowerCase().trim();
      }
    },

    sortCompare(a, b) {
      const key = this.state.sortBy;
      const dir = this.state.sortDir === 'asc' ? 1 : -1;
      const av = this._sortValue(a, key);
      const bv = this._sortValue(b, key);

      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;

      if (av instanceof Date && bv instanceof Date) return (av - bv) * dir;
      if (typeof av === 'number' && typeof bv === 'number') return (av - bv) * dir;

      return av.localeCompare(bv, undefined, { numeric:true, sensitivity:'base' }) * dir;
    },
    /* =============== FIN ORDENACIÓN =============== */

    /* ================== RENDER ================== */
    renderTable(data, selector, emptyMessage) {
      const tbody = document.querySelector(selector);
      tbody.innerHTML = '';
      if (!data.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 10; td.style.textAlign = 'center';
        td.style.color = '#bc348b';
        td.textContent = emptyMessage;
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.dataset.id = String(r.ID);
        ['ID','Sala','Capacidad','Ciudad','Centro','Motivo','Personas','Inicio','Fin'].forEach(f => {
          const td = document.createElement('td');
          td.textContent = r[f] ?? '';
          tr.appendChild(td);
        });
        const tdA = document.createElement('td');
        tdA.classList.add('actions');
        const btnE = document.createElement('button');
        btnE.textContent = '✏️';
        btnE.title = 'Editar';
        btnE.addEventListener('click', () => this.openEditModal(tr.dataset.id));
        const btnD = document.createElement('button');
        btnD.textContent = '🗑️';
        btnD.title = 'Eliminar';
        btnD.addEventListener('click', () => this.openDeleteModal(tr.dataset.id));
        tdA.append(btnE, btnD);
        tr.appendChild(tdA);
        tbody.appendChild(tr);
      });
    },

    /* ================== EDITAR ================== */
    openEditModal(id) {
      const r = this.state.misReservas.find(x => String(x.ID) === id);
      if (!r) return;
      this.state.currentEditId = id;
      document.getElementById('editMotivo').value = r.Motivo || '';
      document.getElementById('editMotivoMod').value = '';

      [['Inicio','editFechaInicio','editHoraInicio'], ['Fin','editFechaFin','editHoraFin']].forEach(([field, dateEl, timeEl]) => {
        const val = r[field] || '';
        const parsed = /^([0-3]?\d)\/([0-1]?\d)\/(\d{4}) (\d{2}:\d{2})$/.exec(val);
        if (parsed) {
          const [, d, m, y, time] = parsed;
          const fechaISO = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
          document.getElementById(dateEl).value = fechaISO;
          document.getElementById(timeEl).value = time;
          if (window[`fp_${dateEl}`]) window[`fp_${dateEl}`].setDate(fechaISO, false, 'Y-m-d');
          if (window[`fp_${timeEl}`]) window[`fp_${timeEl}`].setDate(time, false, 'H:i');
        } else {
          document.getElementById(dateEl).value = '';
          document.getElementById(timeEl).value = '';
        }
      });

      document.getElementById('editModal').style.display = 'flex';
    },

    closeEditModal() { document.getElementById('editModal').style.display = 'none'; },

    handleEditSubmit(e) {
      e.preventDefault();
      const motivoCambio = document.getElementById('editMotivoMod').value.trim();
      const fechaInicio = document.getElementById('editFechaInicio').value;
      const fechaFin    = document.getElementById('editFechaFin').value;
      const horaInicio  = document.getElementById('editHoraInicio').value;
      const horaFin     = document.getElementById('editHoraFin').value;
      const inicio = `${fechaInicio}T${horaInicio}`;
      const fin    = `${fechaFin}T${horaFin}`;
      if (!motivoCambio) {
        alert('Debes indicar el motivo de la modificación.');
        return;
      }
      if (new Date(fin) <= new Date(inicio)) {
        alert('La fecha fin no puede ser anterior a la fecha inicio.');
        return;
      }
      this.closeEditModal();
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(() => {
          this.loadMisReservas();
          this.showInfoModal('Reserva actualizada correctamente.', '¡Reserva Actualizada!');
        })
        .withFailureHandler(err => {
          if (typeof hideSpinner === 'function') hideSpinner();
          console.error(err);
          this.showInfoModal('Error actualizando la reserva.', 'Error');
        })
        .actualizarReserva({
          id: this.state.currentEditId,
          motivo: document.getElementById('editMotivo').value.trim(),
          fechaInicio: inicio,
          fechaFin: fin,
          motivoCambio
        });
    },

    /* ================== ELIMINAR ================== */
    openDeleteModal(id) {
      this.state.deleteId = id;
      document.getElementById('misDeleteMsg').textContent = `¿Eliminar la reserva ${id}?`;
      document.getElementById('misDeleteOverlay').style.display = 'flex';
    },

    closeDeleteModal() { document.getElementById('misDeleteOverlay').style.display = 'none'; },

    confirmDelete() {
      this.closeDeleteModal();
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(() => {
          this.loadMisReservas();
          this.showInfoModal('Reserva eliminada correctamente.', '¡Reserva Eliminada!');
        })
        .withFailureHandler(err => {
          if (typeof hideSpinner === 'function') hideSpinner();
          console.error(err);
          this.showInfoModal('Error eliminando la reserva.', 'Error');
        })
        .eliminarReserva(this.state.deleteId);
    },

    /* ================== EXPORT ================== */
    exportCsv() {
      if (typeof showSpinner === 'function') showSpinner();
      google.script.run
        .withSuccessHandler(csv => {
          if (typeof hideSpinner === 'function') hideSpinner();
          downloadText(csv, 'mis-reservas.csv', 'text/csv');
        })
        .withFailureHandler(err => {
          if (typeof hideSpinner === 'function') hideSpinner();
          console.error(err);
          this.showInfoModal('Error exportando las reservas.', 'Error');
        })
        .exportMisReservasCsv();
    },
   
    /* ================== INFO ================== */
    showInfoModal(msg, header='Información') {
      document.getElementById('infoHeader').textContent = header;
      document.getElementById('infoMsg').textContent = msg;
      document.getElementById('infoOverlay').style.display = 'flex';
    },
    hideInfoModal() { document.getElementById('infoOverlay').style.display = 'none'; },

    /* ================== INIT ================== */
    init() {
      // Filtros
      document.getElementById('filterCiudadMis')
        .addEventListener('change', () => {
          this.poblarCentros();
          this.poblarSalas();
          this.applyFiltersAndRender();
        });
      document.getElementById('filterCentroMis')
        .addEventListener('change', () => {
          this.poblarSalas();
          this.applyFiltersAndRender();
        });
      document.getElementById('filterSalaMis')
        .addEventListener('change', this.applyFiltersAndRender.bind(this));
      document.getElementById('filterFechaMis')
        .addEventListener('change', this.applyFiltersAndRender.bind(this));
      document.getElementById('filterFechaMis')
        .addEventListener('input', this.applyFiltersAndRender.bind(this));
      document.getElementById('searchIdMis')
        .addEventListener('input', this.applyFiltersAndRender.bind(this));

      document.getElementById('mis-clear-filters')
        .addEventListener('click', () => this.limpiarFiltros());

      document.getElementById('mis-reservas-reload')
        .addEventListener('click', this.loadMisReservas.bind(this));
      document.getElementById('mis-export-csv')
        .addEventListener('click', this.exportCsv.bind(this));

      // editar
      document.getElementById('btnEditCancelar')
        .addEventListener('click', this.closeEditModal.bind(this));
      document.getElementById('formEditReserva')
        .addEventListener('submit', this.handleEditSubmit.bind(this));
      document.getElementById('editModal')
        .addEventListener('click', e => {
          if (e.target === e.currentTarget) this.closeEditModal();
        });

      // eliminar
      document.getElementById('misBtnDeleteCancel')
        .addEventListener('click', this.closeDeleteModal.bind(this));
      document.getElementById('misBtnDeleteOk')
        .addEventListener('click', this.confirmDelete.bind(this));
      document.getElementById('misDeleteOverlay')
        .addEventListener('click', e => {
          if (e.target === e.currentTarget) this.closeDeleteModal();
        });

      // info genérico
      document.getElementById('btnInfoOk')
        .addEventListener('click', this.hideInfoModal.bind(this));
      document.getElementById('infoOverlay')
        .addEventListener('click', e => {
          if (e.target === e.currentTarget) this.hideInfoModal();
        });

      // menú lateral (si navega a la pestaña)
      const menuLink = document.querySelector('.navbar-menu a[href="#mybookings"]');
      if (menuLink) {
        menuLink.addEventListener('click', () =>
          setTimeout(() => this.loadMisReservas(), 0)
        );
      }

      // Ordenación
      this.setupSorting();

      // primer fetch
      this.loadMisReservas();
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    App.captureDeepLinkFilters();
    App.init();
  });

  window.MisReservasApp = App;
  window.loadMisReservas = App.loadMisReservas.bind(App);
</script>
